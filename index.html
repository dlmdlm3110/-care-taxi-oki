
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>介護タクシー位置共有アプリ「いまここ」</title>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: #2d3436;
            overflow-x: hidden;
        }

        /* スタート画面の中央配置 */
        .app-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .step-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(116, 185, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            z-index: 1000;
        }

        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .step {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #00b894;
            transform: scale(1.1);
        }

        .step.inactive {
            background: rgba(255, 255, 255, 0.3);
        }

        .step.completed {
            background: #0984e3;
        }

        .main-content {
            width: 100%;
            max-width: 500px;
            margin-top: 120px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-title {
            font-size: 28px;
            font-weight: bold;
            color: #0984e3;
            margin-bottom: 10px;
        }

        .app-subtitle {
            font-size: 16px;
            color: #636e72;
            margin-bottom: 40px;
        }

        .icon {
            font-size: 80px;
            color: #e17055;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2d3436;
        }

        .description {
            font-size: 18px;
            line-height: 1.6;
            color: #636e72;
            margin-bottom: 40px;
        }

        .btn {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #00b894;
            color: white;
        }

        .btn-primary:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #74b9ff;
            color: white;
            margin-top: 15px;
        }

        .btn-secondary:hover {
            background: #0984e3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e17055;
            color: white;
        }

        .btn-danger:hover {
            background: #d63031;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3436;
        }

        .form-group input {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0984e3;
        }

        .image-upload-section {
            margin-bottom: 25px;
            text-align: left;
        }

        .image-upload-label {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3436;
        }

        .image-upload-container {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .image-upload-container:hover {
            border-color: #0984e3;
        }

        .image-preview {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            margin: 10px auto;
            display: none;
        }

        .file-input {
            display: none;
        }

        .upload-text {
            color: #636e72;
            font-size: 16px;
            margin-top: 10px;
        }

        #map {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .map-btn {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 60px;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            z-index: 1000;
        }

        .timer {
            font-size: 32px;
            font-weight: bold;
            color: #0984e3;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 14px;
            color: #636e72;
            margin-bottom: 15px;
        }

        .company-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .map-type-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 20px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-message {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-message {
            background: #00b894;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #0984e3;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #0984e3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .saved-info-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #00b894;
        }

        .saved-info-title {
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .saved-info-item {
            margin-bottom: 8px;
            color: #636e72;
        }

        .change-info-btn {
            background: #74b9ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .delete-saved-btn {
            background: #e17055;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            margin-left: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            .main-content {
                margin-top: 100px;
            }

            .card {
                padding: 30px 20px;
            }

            .step-indicators {
                gap: 15px;
            }

            .step {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .map-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                gap: 10px;
            }

            .info-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 25px 15px;
            }

            .app-title {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            .description {
                font-size: 16px;
            }

            .btn {
                font-size: 18px;
                padding: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Step Header -->
    <div class="step-header">
        <div class="step-indicators">
            <div class="step active" id="step1">1</div>
            <div class="step inactive" id="step2">2</div>
            <div class="step inactive" id="step3">3</div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <div class="main-content">
            <!-- Step 1: Location Permission -->
            <div id="locationStep" class="card">
                <div class="app-title">介護タクシー位置共有アプリ「いまここ」</div>
                <div class="app-subtitle">沖縄県内の介護タクシー事業者向け</div>
                
                <div class="icon">📍</div>
                <h2>位置情報を許可してください</h2>
                <div class="description">
                    「いまここ」では正確な位置情報が必要です。<br>
                    ブラウザから位置情報の許可を求められたら<br>
                    「許可」をタップしてください。
                </div>
                <button class="btn btn-primary" onclick="requestLocation()">
                    <i class="fas fa-map-marker-alt"></i>
                    位置情報を取得
                </button>
            </div>

            <!-- Step 2: Company Information -->
            <div id="infoStep" class="card hidden">
                <div class="icon">👤</div>
                <h2>事業者情報を入力</h2>
                <div class="description">会社名と電話番号を入力してください</div>
                
                <!-- Error/Success Messages -->
                <div id="errorMessage" class="error-message hidden"></div>
                <div id="successMessage" class="success-message hidden"></div>
                
                <!-- Saved Info Display -->
                <div id="savedInfoDisplay" class="saved-info-display hidden">
                    <div class="saved-info-title">保存済みの情報</div>
                    <div id="savedInfoContent"></div>
                    <button class="change-info-btn" onclick="showInfoForm()">情報を変更</button>
                    <button class="delete-saved-btn" onclick="deleteSavedInfo()">保存した情報を削除</button>
                    <button class="btn btn-primary" onclick="useSavedInfo()" style="margin-top: 20px;">
                        <i class="fas fa-map"></i>
                        そのまま地図に登録
                    </button>
                </div>

                <!-- Info Form -->
                <div id="infoForm">
                    <div class="form-group">
                        <label for="companyName"><i class="fas fa-building"></i> 会社名</label>
                        <input type="text" id="companyName" placeholder="○○介護タクシー" required>
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber"><i class="fas fa-phone"></i> 電話番号</label>
                        <input type="tel" id="phoneNumber" placeholder="090-1234-5678" required>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="image-upload-section">
                        <label class="image-upload-label">
                            <i class="fas fa-image"></i> カスタムピン画像（任意）
                        </label>
                        <div class="image-upload-container" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #74b9ff;"></i>
                            <div class="upload-text">📁 画像を選択してカスタムピンを作成</div>
                            <div class="upload-text" style="font-size: 14px;">JPG, PNG, GIF対応（2MB以下）</div>
                            <img id="imagePreview" class="image-preview" alt="プレビュー">
                        </div>
                        <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
                    </div>

                    <button class="btn btn-primary" onclick="registerLocation()">
                        <i class="fas fa-map"></i>
                        地図に登録する
                    </button>
                </div>
            </div>

            <!-- Step 3: Map View -->
            <div id="mapStep" class="hidden">
                <div class="map-container">
                    <div id="map"></div>
                    
                    <!-- Info Panel -->
                    <div class="info-panel">
                        <div class="timer" id="countdown">08:00:00</div>
                        <div class="status-text">残り時間: 8時間後に自動的に削除されます</div>
                        <div class="company-info">
                            <i class="fas fa-users"></i>
                            <span id="operatorCount">1台の介護タクシーが稼働中</span>
                        </div>
                        <div style="font-size: 14px; color: #636e72;">
                            <i class="fas fa-phone"></i>
                            マーカーをタップして電話発信
                        </div>
                    </div>

                    <!-- Map Type Toggle -->
                    <button class="map-type-toggle" id="mapTypeToggle" onclick="toggleMapType()" title="地図表示を切り替え">
                        <i class="fas fa-map"></i>
                    </button>

                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="map-btn btn-secondary" onclick="updateLocation()">
                            <i class="fas fa-sync-alt"></i>
                            位置更新
                        </button>
                        <button class="map-btn btn-danger" onclick="endOperation()">
                            <i class="fas fa-trash"></i>
                            稼働終了
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
        <div class="loading">
            <div class="spinner"></div>
            処理中...
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/compat/firebase-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/compat/firebase-firestore.js"></script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8NRDN9NszAV2vnMbhej2Vh-bpqDxCuqU&libraries=geometry"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCJIGNkMZJr4pPvG2YMAx2QaySnD-LZZs",
            authDomain: "care-taxi-okinawa.firebaseapp.com",
            projectId: "care-taxi-okinawa",
            storageBucket: "care-taxi-okinawa.firebasestorage.app",
            messagingSenderId: "1052247620667",
            appId: "1:1052247620667:web:6ccf1f12f5ec6bf36f0f0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collection = db.collection('care_taxi_locations');

        // App State
        let currentPosition = null;
        let map = null;
        let markers = [];
        let currentMarker = null;
        let unsubscribe = null;
        let countdownTimer = null;
        let expirationTime = null;
        let currentDocumentId = null;
        let isMapTypeSatellite = false;

        // Default coordinates (Naha, Okinawa)
        const defaultLocation = {
            lat: 26.2124,
            lng: 127.6792
        };

        console.log('Firebase初期化完了');

        // Check for saved info on page load
        window.addEventListener('load', function() {
            checkSavedInfo();
        });

        function checkSavedInfo() {
            const savedCompany = localStorage.getItem('care_taxi_company');
            const savedPhone = localStorage.getItem('care_taxi_phone');
            const savedImage = localStorage.getItem('care_taxi_image');

            if (savedCompany && savedPhone) {
                showSavedInfoDisplay(savedCompany, savedPhone, savedImage);
            }
        }

        function showSavedInfoDisplay(company, phone, image) {
            const savedInfoDisplay = document.getElementById('savedInfoDisplay');
            const savedInfoContent = document.getElementById('savedInfoContent');
            const infoForm = document.getElementById('infoForm');

            let imageText = '';
            if (image) {
                imageText = '<div class="saved-info-item"><i class="fas fa-image"></i> カスタムピン画像: 保存済み</div>';
            }

            savedInfoContent.innerHTML = `
                <div class="saved-info-item"><i class="fas fa-building"></i> 会社名: ${company}</div>
                <div class="saved-info-item"><i class="fas fa-phone"></i> 電話番号: ${phone}</div>
                ${imageText}
            `;

            savedInfoDisplay.classList.remove('hidden');
            infoForm.classList.add('hidden');
        }

        function showInfoForm() {
            const savedInfoDisplay = document.getElementById('savedInfoDisplay');
            const infoForm = document.getElementById('infoForm');

            savedInfoDisplay.classList.add('hidden');
            infoForm.classList.remove('hidden');

            // Fill form with saved data
            const savedCompany = localStorage.getItem('care_taxi_company');
            const savedPhone = localStorage.getItem('care_taxi_phone');
            const savedImage = localStorage.getItem('care_taxi_image');

            if (savedCompany) document.getElementById('companyName').value = savedCompany;
            if (savedPhone) document.getElementById('phoneNumber').value = savedPhone;
            if (savedImage) {
                const preview = document.getElementById('imagePreview');
                preview.src = savedImage;
                preview.style.display = 'block';
            }
        }

        function deleteSavedInfo() {
            if (confirm('保存された情報を削除しますか？')) {
                localStorage.removeItem('care_taxi_company');
                localStorage.removeItem('care_taxi_phone');
                localStorage.removeItem('care_taxi_image');

                const savedInfoDisplay = document.getElementById('savedInfoDisplay');
                const infoForm = document.getElementById('infoForm');

                savedInfoDisplay.classList.add('hidden');
                infoForm.classList.remove('hidden');

                // Clear form
                document.getElementById('companyName').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('imagePreview').style.display = 'none';

                showSuccessMessage('保存された情報を削除しました');
            }
        }

        function useSavedInfo() {
            const savedCompany = localStorage.getItem('care_taxi_company');
            const savedPhone = localStorage.getItem('care_taxi_phone');

            if (savedCompany && savedPhone) {
                document.getElementById('companyName').value = savedCompany;
                document.getElementById('phoneNumber').value = savedPhone;
                registerLocation();
            }
        }

        // Location Request
        function requestLocation() {
            showLoading(true);
            
            if (!navigator.geolocation) {
                showErrorMessage('位置情報がサポートされていません');
                showLoading(false);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('位置情報取得成功:', currentPosition);
                    showLoading(false);
                    goToStep(2);
                },
                (error) => {
                    console.error('位置情報取得エラー:', error);
                    currentPosition = defaultLocation;
                    showErrorMessage('位置情報の取得に失敗しました。デフォルト位置（沖縄県那覇市）を使用します。');
                    showLoading(false);
                    goToStep(2);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        // Image Upload Handling
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showErrorMessage('画像ファイルを選択してください');
                return;
            }

            // Validate file size (2MB)
            if (file.size > 2 * 1024 * 1024) {
                showErrorMessage('ファイルサイズは2MB以下にしてください');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Create canvas for resizing
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size to 32x32
                    canvas.width = 32;
                    canvas.height = 32;
                    
                    // Draw resized image
                    ctx.drawImage(img, 0, 0, 32, 32);
                    
                    // Get base64 data
                    const resizedImageData = canvas.toDataURL('image/png');
                    
                    // Show preview
                    const preview = document.getElementById('imagePreview');
                    preview.src = resizedImageData;
                    preview.style.display = 'block';
                    
                    console.log('画像アップロード完了');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Phone Number Formatting
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
            }
            e.target.value = value;
        });

        // Register Location
        async function registerLocation() {
            const companyName = document.getElementById('companyName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const imagePreview = document.getElementById('imagePreview');
            let customImage = null;

            if (!companyName || !phoneNumber) {
                showErrorMessage('会社名と電話番号を入力してください');
                return;
            }

            if (!currentPosition) {
                showErrorMessage('位置情報を取得できませんでした');
                return;
            }

            // Get custom image if uploaded
            if (imagePreview.style.display !== 'none' && imagePreview.src) {
                customImage = imagePreview.src;
            }

            showLoading(true);

            try {
                // Delete existing data for the same phone number
                const existingQuery = collection.where('phone_number', '==', phoneNumber);
                const existingSnapshot = await existingQuery.get();
                
                const deletePromises = existingSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);

                console.log(`削除された既存データ: ${deletePromises.length}件`);

                // Create new document
                const now = new Date();
                const expiresAt = new Date(now.getTime() + 8 * 60 * 60 * 1000);

                const docData = {
                    company_name: companyName,
                    phone_number: phoneNumber,
                    latitude: currentPosition.lat,
                    longitude: currentPosition.lng,
                    created_at: now,
                    expires_at: expiresAt
                };

                if (customImage) {
                    docData.custom_image = customImage;
                }

                const docRef = await collection.add(docData);
                currentDocumentId = docRef.id;
                expirationTime = expiresAt;

                // Save to localStorage
                localStorage.setItem('care_taxi_company', companyName);
                localStorage.setItem('care_taxi_phone', phoneNumber);
                if (customImage) {
                    localStorage.setItem('care_taxi_image', customImage);
                }

                console.log('データ登録成功:', docRef.id);
                showLoading(false);
                goToStep(3);
                initMap();
                startCountdown();
                setupAutoDelete();

            } catch (error) {
                console.error('登録エラー:', error);
                showErrorMessage('登録に失敗しました: ' + error.message);
                showLoading(false);
            }
        }

        // Initialize Map
        function initMap() {
            const mapOptions = {
                center: currentPosition || defaultLocation,
                zoom: 11,
                mapTypeId: isMapTypeSatellite ? google.maps.MapTypeId.SATELLITE : google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            };

            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            console.log('Google Maps初期化完了');

            // Apply saved map type
            const savedMapType = localStorage.getItem('care_taxi_map_type');
            if (savedMapType === 'satellite') {
                isMapTypeSatellite = true;
                map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                updateMapTypeButton();
            }

            subscribeToOperators();
        }

        // Map Type Toggle
        function toggleMapType() {
            isMapTypeSatellite = !isMapTypeSatellite;
            
            if (isMapTypeSatellite) {
                map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                localStorage.setItem('care_taxi_map_type', 'satellite');
            } else {
                map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                localStorage.setItem('care_taxi_map_type', 'roadmap');
            }
            
            updateMapTypeButton();
            console.log('地図表示切り替え:', isMapTypeSatellite ? '航空写真' : 'デフォルト');
        }

        function updateMapTypeButton() {
            const button = document.getElementById('mapTypeToggle');
            if (isMapTypeSatellite) {
                button.innerHTML = '<i class="fas fa-satellite"></i>';
                button.title = '航空写真表示中 - クリックで地図に切り替え';
            } else {
                button.innerHTML = '<i class="fas fa-map"></i>';
                button.title = 'デフォルト地図表示中 - クリックで航空写真に切り替え';
            }
        }

        // Subscribe to Firestore Updates
        function subscribeToOperators() {
            const now = new Date();
            
            unsubscribe = collection
                .where('expires_at', '>', now)
                .onSnapshot((snapshot) => {
                    console.log(`Firestoreデータ取得: ${snapshot.docs.length}件`);
                    updateMarkers(snapshot.docs);
                    updateOperatorCount(snapshot.docs.length);
                }, (error) => {
                    console.error('Firestore監視エラー:', error);
                });
        }

        // Update Markers
        function updateMarkers(docs) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const currentPhone = localStorage.getItem('care_taxi_phone');

            docs.forEach(doc => {
                const data = doc.data();
                const isCurrentUser = data.phone_number === currentPhone;

                console.log(`マーカー作成: ${data.company_name} at ${data.latitude}, ${data.longitude}`);

                let iconOptions;
                if (data.custom_image) {
                    iconOptions = {
                        url: data.custom_image,
                        scaledSize: new google.maps.Size(32, 32),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(16, 32)
                    };
                } else {
                    iconOptions = {
                        url: isCurrentUser ? 
                            'https://maps.google.com/mapfiles/ms/icons/red-dot.png' :
                            'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                        scaledSize: new google.maps.Size(32, 32)
                    };
                }

                const marker = new google.maps.Marker({
                    position: { 
                        lat: Number(data.latitude), 
                        lng: Number(data.longitude) 
                    },
                    map: map,
                    title: data.company_name,
                    icon: iconOptions
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; min-width: 200px;">
                            <h3 style="margin: 0; font-size: 16px; color: #2d3436;">${data.company_name}</h3>
                            <p style="margin: 5px 0;">
                                <a href="tel:${data.phone_number}" 
                                   style="color: #0984e3; text-decoration: none; font-size: 18px; font-weight: bold;">
                                    📞 ${data.phone_number}
                                </a>
                            </p>
                            <small style="color: #636e72;">タップで電話をかけます</small>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);

                if (isCurrentUser) {
                    currentMarker = marker;
                }
            });
        }

        // Update Operator Count
        function updateOperatorCount(count) {
            const operatorCount = document.getElementById('operatorCount');
            operatorCount.textContent = `${count}台の介護タクシーが稼働中`;
        }

        // Countdown Timer
        function startCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }

            countdownTimer = setInterval(() => {
                if (!expirationTime) return;

                const now = new Date();
                const timeLeft = expirationTime - now;

                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById('countdown').textContent = '00:00:00';
                    endOperation();
                    return;
                }

                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                document.getElementById('countdown').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Update Location
        function updateLocation() {
            if (!navigator.geolocation) {
                showErrorMessage('位置情報がサポートされていません');
                return;
            }

            showLoading(true);

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const newPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    try {
                        if (currentDocumentId) {
                            await collection.doc(currentDocumentId).update({
                                latitude: newPosition.lat,
                                longitude: newPosition.lng,
                                updated_at: new Date()
                            });

                            currentPosition = newPosition;
                            map.setCenter(newPosition);
                            
                            showSuccessMessage('位置情報を更新しました');
                            console.log('位置情報更新成功:', newPosition);
                        }
                    } catch (error) {
                        console.error('位置更新エラー:', error);
                        showErrorMessage('位置情報の更新に失敗しました');
                    }

                    showLoading(false);
                },
                (error) => {
                    console.error('位置情報取得エラー:', error);
                    showErrorMessage('位置情報の取得に失敗しました');
                    showLoading(false);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // End Operation
        function endOperation() {
            if (confirm('稼働を終了しますか？\n位置情報が地図から削除されます。')) {
                deleteCurrentLocation();
            }
        }

        // Delete Current Location
        async function deleteCurrentLocation() {
            showLoading(true);

            try {
                if (currentDocumentId) {
                    await collection.doc(currentDocumentId).delete();
                    console.log('位置情報削除成功');
                }

                // Clean up
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }
                if (unsubscribe) {
                    unsubscribe();
                }

                showSuccessMessage('稼働を終了しました');
                
                setTimeout(() => {
                    goToStep(1);
                    resetApp();
                }, 2000);

            } catch (error) {
                console.error('削除エラー:', error);
                showErrorMessage('削除に失敗しました');
            }

            showLoading(false);
        }

        // Auto-delete setup
        function setupAutoDelete() {
            // Browser close detection
            window.addEventListener('beforeunload', function(e) {
                if (currentDocumentId) {
                    navigator.sendBeacon('/api/delete', JSON.stringify({
                        docId: currentDocumentId
                    }));
                }
            });

            window.addEventListener('unload', function(e) {
                if (currentDocumentId) {
                    deleteCurrentLocation();
                }
            });

            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && currentDocumentId) {
                    deleteCurrentLocation();
                }
            });
        }

        // Navigation Functions
        function goToStep(step) {
            // Hide all steps
            document.getElementById('locationStep').classList.add('hidden');
            document.getElementById('infoStep').classList.add('hidden');
            document.getElementById('mapStep').classList.add('hidden');

            // Update step indicators
            document.getElementById('step1').className = step >= 1 ? 'step completed' : 'step inactive';
            document.getElementById('step2').className = step >= 2 ? 'step completed' : 'step inactive';
            document.getElementById('step3').className = step >= 3 ? 'step completed' : 'step inactive';

            if (step <= 3) {
                document.getElementById(`step${step}`).className = 'step active';
            }

            // Show current step
            switch (step) {
                case 1:
                    document.getElementById('locationStep').classList.remove('hidden');
                    break;
                case 2:
                    document.getElementById('infoStep').classList.remove('hidden');
                    checkSavedInfo();
                    break;
                case 3:
                    document.getElementById('mapStep').classList.remove('hidden');
                    document.querySelector('.step-header').style.display = 'none';
                    break;
            }
        }

        // Utility Functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showSuccessMessage(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        function resetApp() {
            currentPosition = null;
            map = null;
            markers = [];
            currentMarker = null;
            unsubscribe = null;
            countdownTimer = null;
            expirationTime = null;
            currentDocumentId = null;
            
            document.querySelector('.step-header').style.display = 'block';
            document.getElementById('companyName').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (unsubscribe) {
                unsubscribe();
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDiH%2FrGNE7p76pn5%2BfV9VEbk1IW7aHxGYMMNsAZCqc6bcMGiwiFaEJyzuKEor2j5b5HFECFmToI8aXP7jcv%2F2izrkcqE37gVIzsW0603ShlUN2lOijkx6EzO1j6%2FKI7xHHfc1nDRzew5scDa3fV%2BPfEerJRlE8Werjh5I9ESz9fkeLt7vG0FiwIjV%2BsxOHGYUTSqOMzMsyYQKz8YaYW1yoKpofan%2B5OV4iiST9iFYiHAcDUXo2E7sEGmVWj8RwhDTLbhsQwLDYCdWzxP6iNefiZNXv5S2U9bzu92EG%2BmeJVer%2B1yI60dUtX1JcKSn%2BnUEHdEovfjaT7P5HXhEvoALsfxmgfwvHohTbONBa4a9e5zJek6wcs2ELVFe4I5Ec9ATT7Xez%2B7Y4%2BT4vpTwzIO5s4ARzgjMDhwyR1vo%2BkCsWf5UbDiLkpHsDjHpCxup5qwM%2B6NuXlvqgIqJmfue7hRFGQ%2ByAYPMOApSBd0n7GcPpuOPqC7fAoKZdOPld2LleloUvg%3D%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDiH/rGNE7p76pn5+fV9VEbk1IW7aHxGYMMNsAZCqc6bcMGiwiFaEJyzuKEor2j5b5HFECFmToI8aXP7jcv/2izrkcqE37gVIzsW0603ShlUN2lOijkx6EzO1j6/KI7xHHfc1nDRzew5scDa3fV+PfEerJRlE8Werjh5I9ESz9fkeLt7vG0FiwIjV+sxOHGYUTSqOMzMsyYQKz8YaYW1yoKpofan+5OV4iiST9iFYiHAcDUXo2E7sEGmVWj8RwhDTLbhsQwLDYCdWzxP6iNefiZNXv5S2U9bzu92EG+meJVer+1yI60dUtX1JcKSn+nUEHdEovfjaT7P5HXhEvoALsfxmgfwvHohTbONBa4a9e5zJek6wcs2ELVFe4I5Ec9ATT7Xez+7Y4+T4vpTwzIO5s4ARzgjMDhwyR1vo+kCsWf5UbDiLkpHsDjHpCxup5qwM+6NuXlvqgIqJmfue7hRFGQ+yAYPMOApSBd0n7GcPpuOPqC7fAoKZdOPld2LleloUvg==";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
