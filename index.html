
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>介護タクシー位置共有アプリ「いまここ」</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #4169E1 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 20px;
        }

        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .step.active {
            background: #28a745;
            transform: scale(1.1);
        }

        .step.completed {
            background: #28a745;
        }

        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .location-icon {
            font-size: 80px;
            color: #dc3545;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
        }

        .description {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 40px;
            color: #666;
        }

        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #28a745;
        }

        .image-upload {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            font-size: 16px;
        }

        .map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: none;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .control-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .update-btn {
            background: #ffc107;
            color: #333;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .map-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .card {
                margin: 10px;
                padding: 30px 20px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .timer {
                font-size: 16px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ステップインジケーター -->
        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- ステップ1: 位置情報許可 -->
            <div class="card" id="location-step">
                <div class="location-icon">📍</div>
                <h1>位置情報を許可してください</h1>
                <div class="description">
                    「いまここ」では正確な位置情報が必要です。<br>
                    ブラウザから位置情報の許可を求められたら<br>
                    「許可」をタップしてください。
                </div>
                <button class="btn" id="get-location-btn">
                    📍 位置情報を取得
                </button>
                <div id="location-error" class="error-message hidden"></div>
            </div>

            <!-- ステップ2: 事業者情報入力 -->
            <div class="card hidden" id="info-step">
                <div style="font-size: 60px; margin-bottom: 20px;">👤</div>
                <h1>事業者情報を入力</h1>
                <div class="description">
                    会社名と電話番号を入力してください
                </div>
                
                <div class="form-group">
                    <label for="company-name">🏢 会社名</label>
                    <input type="text" id="company-name" placeholder="○○介護タクシー" required>
                </div>

                <div class="form-group">
                    <label for="phone-number">📞 電話番号</label>
                    <input type="tel" id="phone-number" placeholder="090-1234-5678" required>
                </div>

                <div class="image-upload">
                    <label for="logo-upload" class="file-label">📁 ロゴ画像を選択</label>
                    <input type="file" id="logo-upload" class="file-input" accept="image/*">
                    <div class="image-preview" id="image-preview">
                        <span>画像なし</span>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <button type="button" id="change-info-btn" class="btn" style="background: #6c757d; margin-bottom: 10px;">情報を変更</button>
                    <button type="button" id="clear-saved-btn" class="btn" style="background: #dc3545; font-size: 14px; padding: 10px;">保存した情報を削除</button>
                </div>

                <button class="btn" id="register-btn">
                    🗺️ 地図に登録する
                </button>
                <div id="register-error" class="error-message hidden"></div>
            </div>
        </div>

        <!-- ステップ3: 地図表示 -->
        <div class="map-container" id="map-container">
            <div id="map"></div>
            
            <button class="map-toggle" id="map-toggle" title="地図/航空写真切り替え">
                🗺️
            </button>
            
            <div class="timer" id="timer">
                残り時間: 08:00:00
            </div>
            
            <div class="map-controls">
                <div class="status-info">
                    <p><strong>👥 1台の介護タクシーが稼働中</strong></p>
                    <p>📞 マーカーをタップして電話発信</p>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn update-btn" id="update-location-btn">
                        🔄 位置更新
                    </button>
                    <button class="control-btn delete-btn" id="end-service-btn">
                        🗑️ 稼働終了
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8NRDN9NszAV2vnMbhej2Vh-bpqDxCuqU&libraries=geometry"></script>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCJIGNkMZJr4pPvG2YMAx2QaySnD-LZZs",
            authDomain: "care-taxi-okinawa.firebaseapp.com",
            projectId: "care-taxi-okinawa",
            storageBucket: "care-taxi-okinawa.firebasestorage.app",
            messagingSenderId: "1052247620667",
            appId: "1:1052247620667:web:6ccf1f12f5ec6bf36f0f0"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collection = db.collection('care_taxi_locations');

        class ImakokoApp {
            constructor() {
                this.currentStep = 1;
                this.currentPosition = null;
                this.map = null;
                this.markers = [];
                this.unsubscribe = null;
                this.currentDocId = null;
                this.countdownTimer = null;
                this.expirationTime = null;
                this.isMapSatellite = false;
                
                this.init();
            }

            init() {
                console.log('🚀 いまここアプリ初期化開始');
                this.loadSavedInfo();
                this.bindEvents();
                this.setupAutoDelete();
            }

            bindEvents() {
                // 位置情報取得
                document.getElementById('get-location-btn').addEventListener('click', () => {
                    this.getCurrentPosition();
                });

                // フォーム送信
                document.getElementById('register-btn').addEventListener('click', () => {
                    this.handleRegistration();
                });

                // 電話番号フォーマット
                document.getElementById('phone-number').addEventListener('input', this.formatPhoneNumber);

                // 画像アップロード
                document.getElementById('logo-upload').addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });

                // 情報変更・削除
                document.getElementById('change-info-btn').addEventListener('click', () => {
                    this.showInfoForm();
                });

                document.getElementById('clear-saved-btn').addEventListener('click', () => {
                    this.clearSavedInfo();
                });

                // 地図コントロール
                document.getElementById('update-location-btn').addEventListener('click', () => {
                    this.updateLocation();
                });

                document.getElementById('end-service-btn').addEventListener('click', () => {
                    this.endService();
                });

                document.getElementById('map-toggle').addEventListener('click', () => {
                    this.toggleMapType();
                });
            }

            getCurrentPosition() {
                console.log('📍 位置情報取得開始');
                const btn = document.getElementById('get-location-btn');
                const errorDiv = document.getElementById('location-error');
                
                btn.disabled = true;
                btn.textContent = '位置情報取得中...';
                errorDiv.classList.add('hidden');

                if (!navigator.geolocation) {
                    console.error('❌ Geolocation not supported');
                    this.showLocationError('このブラウザは位置情報をサポートしていません。');
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };

                console.log('🔍 getCurrentPosition実行中', options);

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('✅ 位置情報取得成功', position);
                        this.currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('📍 現在位置:', this.currentPosition);
                        
                        this.showStep(2);
                        btn.disabled = false;
                        btn.textContent = '📍 位置情報を取得';
                    },
                    (error) => {
                        console.error('❌ 位置情報取得エラー:', error);
                        let errorMessage = '';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '位置情報の利用が拒否されました。ブラウザの設定で位置情報を許可してください。';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '位置情報を取得できませんでした。GPS機能をオンにしてください。';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '位置情報の取得がタイムアウトしました。もう一度お試しください。';
                                break;
                            default:
                                errorMessage = '位置情報の取得に失敗しました。もう一度お試しください。';
                                break;
                        }
                        
                        this.showLocationError(errorMessage);
                        btn.disabled = false;
                        btn.textContent = '📍 位置情報を取得';
                    },
                    options
                );
            }

            showLocationError(message) {
                const errorDiv = document.getElementById('location-error');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }

            loadSavedInfo() {
                console.log('💾 保存された情報を読み込み中');
                const savedCompanyName = localStorage.getItem('imakoko_company_name');
                const savedPhoneNumber = localStorage.getItem('imakoko_phone_number');
                const savedImage = localStorage.getItem('imakoko_logo_image');
                const savedMapType = localStorage.getItem('imakoko_map_type');

                if (savedCompanyName && savedPhoneNumber) {
                    console.log('✅ 保存された情報を発見');
                    document.getElementById('company-name').value = savedCompanyName;
                    document.getElementById('phone-number').value = savedPhoneNumber;
                    
                    if (savedImage) {
                        const preview = document.getElementById('image-preview');
                        preview.innerHTML = `<img src="${savedImage}" alt="ロゴ">`;
                    }

                    this.showSavedInfoMode();
                }

                if (savedMapType) {
                    this.isMapSatellite = savedMapType === 'satellite';
                }
            }

            showSavedInfoMode() {
                const companyInput = document.getElementById('company-name');
                const phoneInput = document.getElementById('phone-number');
                const logoUpload = document.getElementById('logo-upload');
                
                companyInput.disabled = true;
                phoneInput.disabled = true;
                logoUpload.disabled = true;
                
                document.querySelector('.image-upload').style.opacity = '0.6';
            }

            showInfoForm() {
                const companyInput = document.getElementById('company-name');
                const phoneInput = document.getElementById('phone-number');
                const logoUpload = document.getElementById('logo-upload');
                
                companyInput.disabled = false;
                phoneInput.disabled = false;
                logoUpload.disabled = false;
                
                document.querySelector('.image-upload').style.opacity = '1';
            }

            clearSavedInfo() {
                if (confirm('保存された情報を削除しますか？')) {
                    localStorage.removeItem('imakoko_company_name');
                    localStorage.removeItem('imakoko_phone_number');
                    localStorage.removeItem('imakoko_logo_image');
                    
                    document.getElementById('company-name').value = '';
                    document.getElementById('phone-number').value = '';
                    document.getElementById('image-preview').innerHTML = '<span>画像なし</span>';
                    
                    this.showInfoForm();
                    
                    alert('保存された情報を削除しました。');
                }
            }

            formatPhoneNumber(event) {
                let value = event.target.value.replace(/\D/g, '');
                if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
                }
                event.target.value = value;
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 2 * 1024 * 1024) {
                    alert('ファイルサイズは2MB以下にしてください。');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = 32;
                        canvas.height = 32;
                        
                        ctx.drawImage(img, 0, 0, 32, 32);
                        const resizedImage = canvas.toDataURL('image/png');
                        
                        const preview = document.getElementById('image-preview');
                        preview.innerHTML = `<img src="${resizedImage}" alt="ロゴ">`;
                        
                        localStorage.setItem('imakoko_logo_image', resizedImage);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            showStep(step) {
                console.log(`🔄 ステップ${step}に移動`);
                
                // ステップインジケーター更新
                for (let i = 1; i <= 3; i++) {
                    const stepEl = document.getElementById(`step${i}`);
                    stepEl.classList.remove('active', 'completed');
                    
                    if (i < step) {
                        stepEl.classList.add('completed');
                    } else if (i === step) {
                        stepEl.classList.add('active');
                    }
                }

                // 画面切り替え
                document.getElementById('location-step').classList.add('hidden');
                document.getElementById('info-step').classList.add('hidden');
                document.getElementById('map-container').style.display = 'none';

                if (step === 1) {
                    document.getElementById('location-step').classList.remove('hidden');
                } else if (step === 2) {
                    document.getElementById('info-step').classList.remove('hidden');
                } else if (step === 3) {
                    document.getElementById('map-container').style.display = 'block';
                    this.initMap();
                }

                this.currentStep = step;
            }

            async handleRegistration() {
                const companyName = document.getElementById('company-name').value.trim();
                const phoneNumber = document.getElementById('phone-number').value.trim();
                const errorDiv = document.getElementById('register-error');
                
                errorDiv.classList.add('hidden');

                if (!companyName || !phoneNumber) {
                    this.showRegisterError('会社名と電話番号を入力してください。');
                    return;
                }

                if (!this.currentPosition) {
                    this.showRegisterError('位置情報を取得してください。');
                    return;
                }

                const btn = document.getElementById('register-btn');
                btn.disabled = true;
                btn.textContent = '登録中...';

                try {
                    // 既存データを削除
                    await this.deleteExistingData(phoneNumber);
                    
                    // 新しいデータを登録
                    await this.registerNewData(companyName, phoneNumber);
                    
                    // 情報を保存
                    localStorage.setItem('imakoko_company_name', companyName);
                    localStorage.setItem('imakoko_phone_number', phoneNumber);
                    
                    this.showStep(3);
                    
                } catch (error) {
                    console.error('❌ 登録エラー:', error);
                    this.showRegisterError('登録に失敗しました: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = '🗺️ 地図に登録する';
                }
            }

            async deleteExistingData(phoneNumber) {
                console.log('🗑️ 既存データを削除中:', phoneNumber);
                
                const query = collection.where('phone_number', '==', phoneNumber);
                const snapshot = await query.get();
                
                const deletePromises = [];
                snapshot.forEach(doc => {
                    console.log('🗑️ 削除対象:', doc.id);
                    deletePromises.push(doc.ref.delete());
                });
                
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                    console.log(`✅ ${deletePromises.length}件の既存データを削除`);
                }
            }

            async registerNewData(companyName, phoneNumber) {
                const now = new Date();
                const expiresAt = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                
                const data = {
                    company_name: companyName,
                    phone_number: phoneNumber,
                    latitude: this.currentPosition.lat,
                    longitude: this.currentPosition.lng,
                    created_at: now,
                    expires_at: expiresAt
                };

                console.log('💾 新しいデータを登録:', data);
                const docRef = await collection.add(data);
                this.currentDocId = docRef.id;
                this.expirationTime = expiresAt;
                
                console.log('✅ 登録完了:', docRef.id);
            }

            showRegisterError(message) {
                const errorDiv = document.getElementById('register-error');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }

            initMap() {
                console.log('🗺️ 地図を初期化中');
                
                const mapOptions = {
                    center: this.currentPosition,
                    zoom: 11,
                    mapTypeId: this.isMapSatellite ? 
                        google.maps.MapTypeId.SATELLITE : 
                        google.maps.MapTypeId.ROADMAP
                };

                this.map = new google.maps.Map(document.getElementById('map'), mapOptions);
                console.log('✅ 地図初期化完了');
                
                this.updateMapToggleButton();
                this.subscribeToData();
                this.startCountdown();
            }

            subscribeToData() {
                console.log('🔔 リアルタイムデータ監視開始');
                
                const now = new Date();
                this.unsubscribe = collection
                    .where('expires_at', '>', now)
                    .onSnapshot((snapshot) => {
                        console.log(`📊 データ更新: ${snapshot.docs.length}件`);
                        this.updateMarkers(snapshot.docs);
                        this.updateStatusInfo(snapshot.docs.length);
                    });
            }

            updateMarkers(docs) {
                // 既存マーカーを削除
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];

                docs.forEach(doc => {
                    const data = doc.data();
                    const isCurrentUser = doc.id === this.currentDocId;
                    
                    console.log('🎯 マーカー作成:', data.company_name, isCurrentUser ? '(自分)' : '(他者)');
                    
                    // カスタム画像を確認
                    let iconUrl = null;
                    if (isCurrentUser) {
                        const savedImage = localStorage.getItem('imakoko_logo_image');
                        if (savedImage) {
                            iconUrl = savedImage;
                        }
                    }

                    const marker = new google.maps.Marker({
                        position: { lat: data.latitude, lng: data.longitude },
                        map: this.map,
                        title: data.company_name,
                        icon: iconUrl ? {
                            url: iconUrl,
                            scaledSize: new google.maps.Size(32, 32),
                            anchor: new google.maps.Point(16, 32)
                        } : {
                            url: isCurrentUser ? 
                                'https://maps.google.com/mapfiles/ms/icons/red-dot.png' :
                                'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; min-width: 200px;">
                                <h3 style="margin: 0; font-size: 16px;">${data.company_name}</h3>
                                <p style="margin: 5px 0;">
                                    <a href="tel:${data.phone_number}" 
                                       style="color: #2563EB; text-decoration: none; font-size: 18px;">
                                        📞 ${data.phone_number}
                                    </a>
                                </p>
                                <small style="color: #666;">タップで電話をかけます</small>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(this.map, marker);
                    });

                    this.markers.push(marker);
                });
            }

            updateStatusInfo(count) {
                const statusInfo = document.querySelector('.status-info p');
                statusInfo.innerHTML = `<strong>👥 ${count}台の介護タクシーが稼働中</strong>`;
            }

            startCountdown() {
                if (!this.expirationTime) return;

                this.countdownTimer = setInterval(() => {
                    const now = new Date();
                    const timeLeft = this.expirationTime - now;

                    if (timeLeft <= 0) {
                        this.handleExpiration();
                        return;
                    }

                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                    const timerElement = document.getElementById('timer');
                    timerElement.textContent = `残り時間: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            handleExpiration() {
                clearInterval(this.countdownTimer);
                alert('8時間が経過したため、位置情報を削除しました。');
                this.endService(false);
            }

            async updateLocation() {
                if (confirm('位置情報を更新しますか？')) {
                    try {
                        const position = await this.getCurrentPositionPromise();
                        this.currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        if (this.currentDocId) {
                            await collection.doc(this.currentDocId).update({
                                latitude: this.currentPosition.lat,
                                longitude: this.currentPosition.lng,
                                updated_at: new Date()
                            });
                            
                            alert('位置情報を更新しました。');
                        }
                    } catch (error) {
                        alert('位置情報の更新に失敗しました。');
                    }
                }
            }

            getCurrentPositionPromise() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
            }

            async endService(showConfirm = true) {
                if (showConfirm && !confirm('稼働を終了しますか？')) {
                    return;
                }

                try {
                    if (this.currentDocId) {
                        await collection.doc(this.currentDocId).delete();
                        console.log('✅ データ削除完了');
                    }

                    if (this.unsubscribe) {
                        this.unsubscribe();
                    }

                    if (this.countdownTimer) {
                        clearInterval(this.countdownTimer);
                    }

                    alert('稼働を終了しました。');
                    window.location.reload();
                } catch (error) {
                    console.error('❌ 削除エラー:', error);
                    alert('削除に失敗しました。');
                }
            }

            toggleMapType() {
                if (!this.map) return;

                this.isMapSatellite = !this.isMapSatellite;
                
                const mapType = this.isMapSatellite ? 
                    google.maps.MapTypeId.SATELLITE : 
                    google.maps.MapTypeId.ROADMAP;
                
                this.map.setMapTypeId(mapType);
                this.updateMapToggleButton();
                
                localStorage.setItem('imakoko_map_type', this.isMapSatellite ? 'satellite' : 'roadmap');
            }

            updateMapToggleButton() {
                const button = document.getElementById('map-toggle');
                button.textContent = this.isMapSatellite ? '🛰️' : '🗺️';
                button.title = this.isMapSatellite ? '地図表示に切り替え' : '航空写真に切り替え';
            }

            setupAutoDelete() {
                // ブラウザ閉鎖時の自動削除
                const deleteData = () => {
                    if (this.currentDocId) {
                        navigator.sendBeacon(`https://firestore.googleapis.com/v1/projects/care-taxi-okinawa/databases/(default)/documents/care_taxi_locations/${this.currentDocId}`, {
                            method: 'DELETE'
                        });
                    }
                };

                window.addEventListener('beforeunload', deleteData);
                window.addEventListener('unload', deleteData);
                
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        deleteData();
                    }
                });
            }
        }

        // アプリ開始
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM読み込み完了 - いまここアプリ開始');
            new ImakokoApp();
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDjvvdOicPi9VaOe3E2xMgONuFyEr9lftr5aT5VJ4gPKgJPs9EONg7MrBwx9ZTRGW42CsmLf3AzhmvbyCENzqFBPeU3nte%2B6QF%2BS9u%2FDNJ%2BndWWNi1O90fO7axI74RHd6qVRnPMaID3UUzU5XFgDi6tr7BaZMCQ8kAuXgyxIO1shzzRHmn%2FoqkbVQPsKHd5Ld47HPuROdHc%2FHnTUNDoxLasg9bp4I%2FD0mMtPQFEps0ZffvThKi5s9OlZq4AKFuEu7ULkCrNjmSOLY4%2BN2eI4xoXC%2FISBE4grmjqvpL%2B1Imn6SPaaS1zWZbaKjITCcQXYd8eSFEFXdMxUj7qQraXSJ%2B%2FnJp43DFiYjZZi%2Bq4rMaCPXJqx2sP7VsMKpzHwmyjzCTyqv2CGxlZDAPdREo8sHFv0aiEYVHnyTeZj8NlorRN4orXZ2vKMU3inmeLP8DxII1E%2FPAYBhxOcYUc82kuuxyzxjBRpVzex4DnI4m7ojNXtVxMx6HNDoH7E7j8tb1Gn9n%2BETnwyLpEKPFU6JUapKbXU%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDjvvdOicPi9VaOe3E2xMgONuFyEr9lftr5aT5VJ4gPKgJPs9EONg7MrBwx9ZTRGW42CsmLf3AzhmvbyCENzqFBPeU3nte+6QF+S9u/DNJ+ndWWNi1O90fO7axI74RHd6qVRnPMaID3UUzU5XFgDi6tr7BaZMCQ8kAuXgyxIO1shzzRHmn/oqkbVQPsKHd5Ld47HPuROdHc/HnTUNDoxLasg9bp4I/D0mMtPQFEps0ZffvThKi5s9OlZq4AKFuEu7ULkCrNjmSOLY4+N2eI4xoXC/ISBE4grmjqvpL+1Imn6SPaaS1zWZbaKjITCcQXYd8eSFEFXdMxUj7qQraXSJ+/nJp43DFiYjZZi+q4rMaCPXJqx2sP7VsMKpzHwmyjzCTyqv2CGxlZDAPdREo8sHFv0aiEYVHnyTeZj8NlorRN4orXZ2vKMU3inmeLP8DxII1E/PAYBhxOcYUc82kuuxyzxjBRpVzex4DnI4m7ojNXtVxMx6HNDoH7E7j8tb1Gn9n+ETnwyLpEKPFU6JUapKbXU=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
