
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ä½ç½®å…±æœ‰ã‚¢ãƒ—ãƒª</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 0 10px;
        }
        
        .step-active {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .step-completed {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .step-inactive {
            background: #9CA3AF;
        }
        
        .input-field {
            font-size: 18px;
            padding: 20px;
            border: 3px solid #E5E7EB;
            border-radius: 12px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
            font-size: 20px;
            font-weight: bold;
            padding: 20px 40px;
            border: none;
            border-radius: 12px;
            width: 100%;
            min-height: 70px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            min-height: 60px;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(245, 158, 11, 0.3);
            min-height: 50px;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }
        
        #map {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        
        .map-container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        
        .control-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
        }
        
        .timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            z-index: 1000;
        }
        
        .status-info {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10B981;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #EF4444;
            color: #DC2626;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .control-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .timer-display {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .step-circle {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-50 min-h-screen">
    <!-- Step 1: Location Permission -->
    <div id="step1" class="container mx-auto px-6 py-8 max-w-md">
        <div class="text-center mb-8">
            <div class="flex justify-center mb-6">
                <div class="step-circle step-active">1</div>
                <div class="step-circle step-inactive">2</div>
                <div class="step-circle step-inactive">3</div>
            </div>
            <div class="text-6xl mb-4">ğŸ“</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-4">ä½ç½®æƒ…å ±ã®è¨±å¯</h1>
            <p class="text-gray-600 mb-8">ä½ç½®æƒ…å ±ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
        </div>
        
        <button id="requestLocationBtn" class="btn-primary">
            <i class="fas fa-map-marker-alt mr-3"></i>
            ä½ç½®æƒ…å ±ã‚’è¨±å¯ã™ã‚‹
        </button>
        
        <div id="locationError" class="error-message hidden">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <div id="locationErrorText">ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
        </div>
    </div>

    <!-- Step 2: Company Information -->
    <div id="step2" class="container mx-auto px-6 py-8 max-w-md hidden">
        <div class="text-center mb-8">
            <div class="flex justify-center mb-6">
                <div class="step-circle step-completed">1</div>
                <div class="step-circle step-active">2</div>
                <div class="step-circle step-inactive">3</div>
            </div>
            <div class="text-6xl mb-4">ğŸ‘”</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-4">äº‹æ¥­è€…æƒ…å ±ã‚’å…¥åŠ›</h1>
            <p class="text-gray-600 mb-8">ä¼šç¤¾åã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>
        
        <form id="companyForm" class="space-y-6">
            <div>
                <label class="block text-lg font-semibold text-gray-700 mb-3">
                    <i class="fas fa-building mr-2"></i>ä¼šç¤¾å
                </label>
                <input type="text" id="companyName" class="input-field" placeholder="ä¾‹ï¼šâ—‹â—‹ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼" required maxlength="30">
            </div>
            
            <div>
                <label class="block text-lg font-semibold text-gray-700 mb-3">
                    <i class="fas fa-phone mr-2"></i>é›»è©±ç•ªå·
                </label>
                <input type="tel" id="phoneNumber" class="input-field" placeholder="090-1234-5678" required>
            </div>
            
            <button type="submit" class="btn-primary">
                <i class="fas fa-map mr-3"></i>
                åœ°å›³ã«ç™»éŒ²ã™ã‚‹
            </button>
        </form>
        
        <div id="registrationError" class="error-message hidden">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <div id="registrationErrorText">ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
        </div>
    </div>

    <!-- Step 3: Map Display -->
    <div id="step3" class="hidden">
        <div class="map-container">
            <div id="map"></div>
            
            <div class="timer-display">
                <div id="timeRemaining">07:59:59</div>
                <div class="text-sm opacity-90">æ®‹ã‚Šæ™‚é–“: 8æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™</div>
            </div>
            
            <div class="control-panel">
                <div class="status-info">
                    <i class="fas fa-users text-green-600 mr-2"></i>
                    <span id="operatorCount">1å°ã®ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ãŒç¨¼åƒä¸­</span>
                    <div class="text-sm text-gray-600 mt-1">
                        <i class="fas fa-phone mr-1"></i>
                        ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›»è©±ç™ºä¿¡
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button id="endOperationBtn" class="btn-danger">
                        <i class="fas fa-power-off mr-2"></i>
                        ç¨¼åƒçµ‚äº†
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="updateLocationBtn" class="btn-secondary">
                            <i class="fas fa-sync-alt mr-2"></i>
                            ä½ç½®æ›´æ–°
                        </button>
                        <button id="deleteLocationBtn" class="btn-secondary">
                            <i class="fas fa-trash-alt mr-2"></i>
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 text-center">
            <div class="loading mb-4 mx-auto"></div>
            <div class="text-lg font-semibold text-gray-700">å‡¦ç†ä¸­...</div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc, 
            doc, 
            updateDoc,
            onSnapshot,
            query,
            where,
            serverTimestamp,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCJIGNkMZJr4pPvG2YMAx2QaySnD-LZZs",
            authDomain: "care-taxi-okinawa.firebaseapp.com",
            projectId: "care-taxi-okinawa",
            storageBucket: "care-taxi-okinawa.firebasestorage.app",
            messagingSenderId: "1052247620667",
            appId: "1:1052247620667:web:6ccf1f12f5ec6bf36f0f0"
        };

        // Initialize Firebase
        console.log('FirebaseåˆæœŸåŒ–é–‹å§‹');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log('FirebaseåˆæœŸåŒ–å®Œäº†');

        class CareTaxiApp {
            constructor() {
                this.currentStep = 1;
                this.userLocation = null;
                this.map = null;
                this.markers = [];
                this.userDocId = null;
                this.unsubscribe = null;
                this.countdownTimer = null;
                this.expirationTime = null;
                
                this.init();
            }
            
            init() {
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
                this.setupEventListeners();
                this.setupBeforeUnloadHandler();
                this.showStep(1);
            }
            
            setupEventListeners() {
                // Step 1: Location request
                document.getElementById('requestLocationBtn').addEventListener('click', () => {
                    this.requestLocation();
                });
                
                // Step 2: Form submission
                document.getElementById('companyForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegistration();
                });
                
                // Phone number formatting
                document.getElementById('phoneNumber').addEventListener('input', this.formatPhoneNumber);
                
                // Map controls
                document.getElementById('updateLocationBtn').addEventListener('click', () => {
                    this.updateLocation();
                });
                
                document.getElementById('deleteLocationBtn').addEventListener('click', () => {
                    this.showDeleteConfirmation();
                });
                
                document.getElementById('endOperationBtn').addEventListener('click', () => {
                    this.showEndOperationConfirmation();
                });
            }
            
            setupBeforeUnloadHandler() {
                // ãƒ–ãƒ©ã‚¦ã‚¶é–‰é–æ™‚ã®è‡ªå‹•å‰Šé™¤
                window.addEventListener('beforeunload', (e) => {
                    console.log('beforeunload: è‡ªå‹•å‰Šé™¤å®Ÿè¡Œ');
                    if (this.userDocId) {
                        this.deleteLocationSync();
                    }
                });
                
                window.addEventListener('unload', () => {
                    console.log('unload: è‡ªå‹•å‰Šé™¤å®Ÿè¡Œ');
                    if (this.userDocId) {
                        this.deleteLocationSync();
                    }
                });
                
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && this.userDocId) {
                        console.log('visibilitychange: è‡ªå‹•å‰Šé™¤å®Ÿè¡Œ');
                        this.deleteLocationSync();
                    }
                });
            }
            
            deleteLocationSync() {
                // åŒæœŸçš„ãªå‰Šé™¤ï¼ˆnavigator.sendBeaconä½¿ç”¨ï¼‰
                if (navigator.sendBeacon && this.userDocId) {
                    const deleteUrl = `https://firestore.googleapis.com/v1/projects/care-taxi-okinawa/databases/(default)/documents/care_taxi_locations/${this.userDocId}`;
                    navigator.sendBeacon(deleteUrl, JSON.stringify({ method: 'DELETE' }));
                }
            }
            
            async requestLocation() {
                const btn = document.getElementById('requestLocationBtn');
                const errorDiv = document.getElementById('locationError');
                
                btn.disabled = true;
                btn.innerHTML = '<div class="loading mr-3"></div>ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
                errorDiv.classList.add('hidden');
                
                try {
                    const position = await this.getCurrentPosition();
                    this.userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    console.log('ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ:', this.userLocation);
                    this.showStep(2);
                } catch (error) {
                    console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    this.showError('locationError', 'locationErrorText', 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-map-marker-alt mr-3"></i>ä½ç½®æƒ…å ±ã‚’è¨±å¯ã™ã‚‹';
                }
            }
            
            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 300000
                        }
                    );
                });
            }
            
            formatPhoneNumber(event) {
                let value = event.target.value.replace(/\D/g, '');
                if (value.length >= 7) {
                    value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 4) {
                    value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
                }
                event.target.value = value;
            }
            
            async handleRegistration() {
                const companyName = document.getElementById('companyName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                
                if (!companyName || !phoneNumber) {
                    this.showError('registrationError', 'registrationErrorText', 'ä¼šç¤¾åã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                if (!this.userLocation) {
                    this.showError('registrationError', 'registrationErrorText', 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }
                
                this.showLoading(true);
                
                try {
                    console.log('äº‹æ¥­è€…ç™»éŒ²é–‹å§‹');
                    const now = new Date();
                    const expiresAt = new Date(now.getTime() + 8 * 60 * 60 * 1000); // 8æ™‚é–“å¾Œ
                    
                    const docData = {
                        company_name: companyName,
                        phone_number: phoneNumber,
                        latitude: this.userLocation.lat,
                        longitude: this.userLocation.lng,
                        created_at: serverTimestamp(),
                        expires_at: Timestamp.fromDate(expiresAt)
                    };
                    
                    console.log('Firestoreã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­:', docData);
                    const docRef = await addDoc(collection(db, 'care_taxi_locations'), docData);
                    this.userDocId = docRef.id;
                    this.expirationTime = expiresAt;
                    
                    console.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:', this.userDocId);
                    
                    this.showStep(3);
                    await this.initializeMap();
                    this.startCountdownTimer();
                    this.subscribeToLocations();
                    
                } catch (error) {
                    console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                    this.showError('registrationError', 'registrationErrorText', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async initializeMap() {
                console.log('åœ°å›³åˆæœŸåŒ–é–‹å§‹');
                
                return new Promise((resolve) => {
                    this.map = new google.maps.Map(document.getElementById('map'), {
                        center: this.userLocation || { lat: 26.2124, lng: 127.6792 }, // æ²–ç¸„çœŒé‚£è¦‡å¸‚
                        zoom: 11,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: false,
                        styles: [
                            {
                                featureType: 'poi',
                                elementType: 'labels',
                                stylers: [{ visibility: 'off' }]
                            }
                        ]
                    });
                    
                    console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†');
                    
                    // åœ°å›³ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                    google.maps.event.addListenerOnce(this.map, 'idle', () => {
                        console.log('åœ°å›³èª­ã¿è¾¼ã¿å®Œäº†');
                        resolve();
                    });
                });
            }
            
            subscribeToLocations() {
                console.log('Firestoreç›£è¦–é–‹å§‹');
                
                try {
                    const locationsRef = collection(db, 'care_taxi_locations');
                    const now = new Date();
                    const q = query(locationsRef, where('expires_at', '>', Timestamp.fromDate(now)));
                    
                    this.unsubscribe = onSnapshot(q, (snapshot) => {
                        console.log(`Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—: ${snapshot.docs.length}ä»¶`);
                        this.updateMarkers(snapshot.docs);
                        this.updateOperatorCount(snapshot.docs.length);
                    }, (error) => {
                        console.error('Firestoreç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
                    });
                    
                } catch (error) {
                    console.error('Firestoreç›£è¦–è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            updateMarkers(docs) {
                console.log('ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°é–‹å§‹');
                
                // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                this.markers.forEach(marker => {
                    marker.setMap(null);
                });
                this.markers = [];
                
                // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
                docs.forEach(doc => {
                    const data = doc.data();
                    const isCurrentUser = doc.id === this.userDocId;
                    
                    console.log(`ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ: ${data.company_name} at (${data.latitude}, ${data.longitude})`);
                    
                    const marker = new google.maps.Marker({
                        position: { 
                            lat: Number(data.latitude), 
                            lng: Number(data.longitude) 
                        },
                        map: this.map,
                        title: data.company_name,
                        icon: {
                            url: isCurrentUser ? 
                                'https://maps.google.com/mapfiles/ms/icons/red-dot.png' :
                                'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 15px; min-width: 200px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold;">${data.company_name}</h3>
                                <p style="margin: 10px 0;">
                                    <a href="tel:${data.phone_number}" 
                                       style="color: #3B82F6; text-decoration: none; font-size: 20px; font-weight: bold; display: block; padding: 10px; background: #F3F4F6; border-radius: 8px;">
                                        <i class="fas fa-phone"></i> ${data.phone_number}
                                    </a>
                                </p>
                                <small style="color: #6B7280;">ã‚¿ãƒƒãƒ—ã§é›»è©±ã‚’ã‹ã‘ã¾ã™</small>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(this.map, marker);
                    });
                    
                    this.markers.push(marker);
                });
                
                console.log(`ãƒãƒ¼ã‚«ãƒ¼ä½œæˆå®Œäº†: ${this.markers.length}å€‹`);
            }
            
            updateOperatorCount(count) {
                const countElement = document.getElementById('operatorCount');
                if (countElement) {
                    countElement.textContent = `${count}å°ã®ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ãŒç¨¼åƒä¸­`;
                }
            }
            
            startCountdownTimer() {
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                }
                
                this.countdownTimer = setInterval(() => {
                    if (!this.expirationTime) return;
                    
                    const now = new Date();
                    const remaining = this.expirationTime.getTime() - now.getTime();
                    
                    if (remaining <= 0) {
                        this.handleExpiration();
                        return;
                    }
                    
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    
                    const timeElement = document.getElementById('timeRemaining');
                    if (timeElement) {
                        timeElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
            
            handleExpiration() {
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                }
                
                alert('8æ™‚é–“ãŒçµŒéã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ãŒè‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ã€‚');
                this.deleteLocation();
            }
            
            async updateLocation() {
                try {
                    this.showLoading(true);
                    const position = await this.getCurrentPosition();
                    
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (this.userDocId) {
                        await updateDoc(doc(db, 'care_taxi_locations', this.userDocId), {
                            latitude: newLocation.lat,
                            longitude: newLocation.lng
                        });
                        
                        this.userLocation = newLocation;
                        this.map.setCenter(newLocation);
                        
                        alert('ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ä½ç½®æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                } finally {
                    this.showLoading(false);
                }
            }
            
            showDeleteConfirmation() {
                if (confirm('ä½ç½®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.deleteLocation();
                }
            }
            
            showEndOperationConfirmation() {
                if (confirm('ç¨¼åƒã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nä½ç½®æƒ…å ±ãŒåœ°å›³ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                    this.deleteLocation();
                }
            }
            
            async deleteLocation() {
                if (!this.userDocId) return;
                
                try {
                    this.showLoading(true);
                    
                    await deleteDoc(doc(db, 'care_taxi_locations', this.userDocId));
                    
                    if (this.unsubscribe) {
                        this.unsubscribe();
                    }
                    
                    if (this.countdownTimer) {
                        clearInterval(this.countdownTimer);
                    }
                    
                    alert('ä½ç½®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ç¨¼åƒã‚’çµ‚äº†ã—ã¾ã™ã€‚');
                    
                    // ã‚¢ãƒ—ãƒªã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                    this.userDocId = null;
                    this.expirationTime = null;
                    this.showStep(1);
                    
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }
            
            showStep(step) {
                document.querySelectorAll('[id^="step"]').forEach(el => {
                    el.classList.add('hidden');
                });
                
                const stepElement = document.getElementById(`step${step}`);
                if (stepElement) {
                    stepElement.classList.remove('hidden');
                    stepElement.classList.add('fade-in');
                }
                
                this.currentStep = step;
            }
            
            showError(containerId, textId, message) {
                const container = document.getElementById(containerId);
                const textElement = document.getElementById(textId);
                
                if (container && textElement) {
                    textElement.textContent = message;
                    container.classList.remove('hidden');
                }
            }
            
            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    if (show) {
                        overlay.classList.remove('hidden');
                    } else {
                        overlay.classList.add('hidden');
                    }
                }
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†ã€ã‚¢ãƒ—ãƒªé–‹å§‹');
            window.careTaxiApp = new CareTaxiApp();
        });
    </script>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8NRDN9NszAV2vnMbhej2Vh-bpqDxCuqU&libraries=geometry"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDi38QtLzTzNsQhPoBL25dCft%2BK4ta3caUWEEXr8ykoM5Eq1Wdr%2BB%2B7tzccoc1%2B%2BNOjnk6bpyO9f6F6Cl2d2PfXHjiEX26KU5eyb28P3s1NOjOAz1PK8T7fou9UNC94SFqF4riVA2itbX0W0c%2FmkIbN9EwR8byEAiPj9OhSOoMqwS7p42OuGgOhpsZULS9Cfw7dn%2BnCAUlJhlci4f4pD6roi8el9jT0ClQQF4vBM8mD5jYWIBhFoVupXkFN%2F6lOWbHyNPa0v%2BXoD33%2FRusC%2BRwkb4dYGictrikNFuUmjZvWc1S%2FIRJ6sHqTXFtcu%2F0vWNYYucBLKdB3EHdCshEh1NMCUIrlMbXF1GXV2SmAOYsT3Ehw2%2B46oHZcPm%2BD5UEvIkCnmFwugb0VsP7Vyu9GcfOmPGngrOVfmojKOZ0%2FGJgxPV6XJ1yjcy5Z13VFVLNtJ5VLAUjgUMczyX9B8z9oo1Zt%2Bv0jfB78ROuQwAiGZ5lYBxH8qOr2LXEduynCk1X%2FdTHYqeiI9ck9BL88SMzBDvvcM%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDi38QtLzTzNsQhPoBL25dCft+K4ta3caUWEEXr8ykoM5Eq1Wdr+B+7tzccoc1++NOjnk6bpyO9f6F6Cl2d2PfXHjiEX26KU5eyb28P3s1NOjOAz1PK8T7fou9UNC94SFqF4riVA2itbX0W0c/mkIbN9EwR8byEAiPj9OhSOoMqwS7p42OuGgOhpsZULS9Cfw7dn+nCAUlJhlci4f4pD6roi8el9jT0ClQQF4vBM8mD5jYWIBhFoVupXkFN/6lOWbHyNPa0v+XoD33/RusC+Rwkb4dYGictrikNFuUmjZvWc1S/IRJ6sHqTXFtcu/0vWNYYucBLKdB3EHdCshEh1NMCUIrlMbXF1GXV2SmAOYsT3Ehw2+46oHZcPm+D5UEvIkCnmFwugb0VsP7Vyu9GcfOmPGngrOVfmojKOZ0/GJgxPV6XJ1yjcy5Z13VFVLNtJ5VLAUjgUMczyX9B8z9oo1Zt+v0jfB78ROuQwAiGZ5lYBxH8qOr2LXEduynCk1X/dTHYqeiI9ck9BL88SMzBDvvcM=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
