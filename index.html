
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªãË≠∑„Çø„ÇØ„Ç∑„Éº‰ΩçÁΩÆÂÖ±Êúâ„Ç¢„Éó„É™„Äå„ÅÑ„Åæ„Åì„Åì„Äç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: #2d3436;
            line-height: 1.6;
        }

        /* „Çπ„Çø„Éº„ÉàÁîªÈù¢„ÅÆ‰∏≠Â§ÆÈÖçÁΩÆ */
        .start-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .step.active {
            background: #00b894;
            transform: scale(1.1);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            margin-bottom: 20px;
        }

        .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #2d3436;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2d3436;
        }

        p {
            font-size: 16px;
            margin-bottom: 20px;
            color: #636e72;
        }

        .btn {
            background: #00b894;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #74b9ff;
        }

        .btn-secondary:hover {
            background: #0984e3;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2d3436;
        }

        input[type="text"], input[type="tel"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #00b894;
        }

        .file-input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            background: #74b9ff;
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s ease;
        }

        .file-input-label:hover {
            background: #0984e3;
        }

        .image-preview {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            margin: 10px auto;
            display: none;
            border: 2px solid #ddd;
        }

        .hidden {
            display: none !important;
        }

        /* Âú∞Âõ≥ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        #mapContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1001;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .update-btn {
            background: #74b9ff;
            color: white;
        }

        .update-btn:hover {
            background: #0984e3;
        }

        .end-btn {
            background: #e74c3c;
            color: white;
        }

        .end-btn:hover {
            background: #c0392b;
        }

        .timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
        }

        .timer-text {
            font-size: 18px;
            font-weight: bold;
            color: #0984e3;
        }

        .status-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
        }

        .map-toggle {
            position: absolute;
            top: 20px;
            right: 150px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 20px;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success {
            background: #00b894;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00b894;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .map-controls {
                left: 20px;
                right: 20px;
                transform: none;
                flex-direction: row;
                justify-content: space-between;
            }

            .control-btn {
                flex: 1;
                margin: 0 5px;
            }
        }
    </style>
</head>
<body>
    <!-- „Çπ„ÉÜ„ÉÉ„Éó1: ‰ΩçÁΩÆÊÉÖÂ†±Ë®±ÂèØÁîªÈù¢ -->
    <div id="step1" class="start-container">
        <div class="container">
            <div class="step-indicator">
                <div class="step active">1</div>
                <div class="step">2</div>
                <div class="step">3</div>
            </div>
            
            <div class="card">
                <div class="icon">üìç</div>
                <h1>‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h1>
                <p>„Äå„ÅÑ„Åæ„Åì„Åì„Äç„Åß„ÅØÊ≠£Á¢∫„Å™‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ<br>„Éñ„É©„Ç¶„Ç∂„Åã„Çâ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆË®±ÂèØ„ÇíÊ±Ç„ÇÅ„Çâ„Çå„Åü„Çâ„ÄåË®±ÂèØ„Äç„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <button class="btn" id="getLocationBtn">
                    üìç ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
                </button>
            </div>
        </div>
    </div>

    <!-- „Çπ„ÉÜ„ÉÉ„Éó2: ‰∫ãÊ•≠ËÄÖÊÉÖÂ†±ÂÖ•ÂäõÁîªÈù¢ -->
    <div id="step2" class="container hidden">
        <div class="step-indicator">
            <div class="step">1</div>
            <div class="step active">2</div>
            <div class="step">3</div>
        </div>
        
        <div class="card">
            <div class="icon">üë§</div>
            <h2>‰∫ãÊ•≠ËÄÖÊÉÖÂ†±„ÇíÂÖ•Âäõ</h2>
            <p>‰ºöÁ§æÂêç„Å®ÈõªË©±Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            
            <form id="operatorForm">
                <div class="input-group">
                    <label for="companyName">üè¢ ‰ºöÁ§æÂêç</label>
                    <input type="text" id="companyName" placeholder="‚óã‚óã‰ªãË≠∑„Çø„ÇØ„Ç∑„Éº" required>
                </div>
                
                <div class="input-group">
                    <label for="phoneNumber">üì± ÈõªË©±Áï™Âè∑</label>
                    <input type="tel" id="phoneNumber" placeholder="090-1234-5678" required>
                </div>

                <div class="file-input-container">
                    <label for="logoFile" class="file-input-label">
                        üìÅ ‰ºöÁ§æ„É≠„Ç¥„ÇíÈÅ∏ÊäûÔºà‰ªªÊÑèÔºâ
                    </label>
                    <input type="file" id="logoFile" class="file-input" accept="image/*">
                    <img id="imagePreview" class="image-preview" alt="„Éó„É¨„Éì„É•„Éº">
                </div>
                
                <button type="submit" class="btn">
                    üó∫Ô∏è Âú∞Âõ≥„Å´ÁôªÈå≤„Åô„Çã
                </button>
                
                <button type="button" class="btn btn-secondary" id="changeInfoBtn" style="display: none;">
                    ‚úèÔ∏è ÊÉÖÂ†±„ÇíÂ§âÊõ¥
                </button>
            </form>
        </div>
    </div>

    <!-- „Çπ„ÉÜ„ÉÉ„Éó3: Âú∞Âõ≥Ë°®Á§∫ÁîªÈù¢ -->
    <div id="mapContainer" class="hidden">
        <div id="map"></div>
        
        <div class="timer-display">
            <div class="timer-text" id="timerDisplay">08:00:00</div>
            <small>ÊÆã„ÇäÊôÇÈñì: 8ÊôÇÈñìÂæå„Å´Ëá™ÂãïÂâäÈô§„Åï„Çå„Åæ„Åô</small>
        </div>
        
        <div class="status-info">
            <div>üë• <span id="operatorCount">1</span>Âè∞„ÅÆ‰ªãË≠∑„Çø„ÇØ„Ç∑„Éº„ÅåÁ®ºÂÉç‰∏≠</div>
            <div>üìû „Éû„Éº„Ç´„Éº„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈõªË©±Áô∫‰ø°</div>
        </div>

        <button id="mapToggle" class="map-toggle" title="Âú∞Âõ≥Âàá„ÇäÊõø„Åà">üó∫Ô∏è</button>
        
        <div class="map-controls">
            <button class="control-btn update-btn" id="updateLocationBtn">
                üîÑ ‰ΩçÁΩÆÊõ¥Êñ∞
            </button>
            <button class="control-btn end-btn" id="endOperationBtn">
                üóëÔ∏è Á®ºÂÉçÁµÇ‰∫Ü
            </button>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div id="loading" class="container hidden">
        <div class="card">
            <div class="loading">
                <div class="spinner"></div>
                <p>Âá¶ÁêÜ‰∏≠...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8NRDN9NszAV2vnMbhej2Vh-bpqDxCuqU&libraries=geometry"></script>

    <script>
        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyCJIGNkMZJr4pPvG2YMAx2QaySnD-LZZs",
            authDomain: "care-taxi-okinawa.firebaseapp.com",
            projectId: "care-taxi-okinawa",
            storageBucket: "care-taxi-okinawa.firebasestorage.app",
            messagingSenderId: "1052247620667",
            appId: "1:1052247620667:web:6ccf1f12f5ec6bf36f0f0"
        };

        // FirebaseÂàùÊúüÂåñ
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collection = db.collection('care_taxi_locations');

        class CareTaxiApp {
            constructor() {
                this.currentStep = 1;
                this.currentPosition = null;
                this.map = null;
                this.markers = [];
                this.unsubscribe = null;
                this.myDocumentId = null;
                this.countdownTimer = null;
                this.expirationTime = null;
                this.isMapTypeRoad = true;

                this.init();
            }

            init() {
                this.loadSavedData();
                this.setupEventListeners();
                this.setupUnloadHandlers();
            }

            loadSavedData() {
                const savedData = localStorage.getItem('careTaxiData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    document.getElementById('companyName').value = data.companyName || '';
                    document.getElementById('phoneNumber').value = data.phoneNumber || '';
                    
                    if (data.customIcon) {
                        const preview = document.getElementById('imagePreview');
                        preview.src = data.customIcon;
                        preview.style.display = 'block';
                    }

                    if (data.companyName && data.phoneNumber) {
                        document.getElementById('changeInfoBtn').style.display = 'block';
                    }
                }

                // „Éû„ÉÉ„Éó„Çø„Ç§„ÉóË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
                const savedMapType = localStorage.getItem('mapType');
                this.isMapTypeRoad = savedMapType !== 'satellite';
            }

            setupEventListeners() {
                // ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Éú„Çø„É≥
                document.getElementById('getLocationBtn').addEventListener('click', () => {
                    this.getCurrentPosition();
                });

                // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
                document.getElementById('operatorForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegistration();
                });

                // ÊÉÖÂ†±Â§âÊõ¥„Éú„Çø„É≥
                document.getElementById('changeInfoBtn').addEventListener('click', () => {
                    document.getElementById('changeInfoBtn').style.display = 'none';
                });

                // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû
                document.getElementById('logoFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e);
                });

                // ÈõªË©±Áï™Âè∑„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                document.getElementById('phoneNumber').addEventListener('input', (e) => {
                    this.formatPhoneNumber(e);
                });

                // Âú∞Âõ≥„Ç≥„É≥„Éà„É≠„Éº„É´
                document.getElementById('updateLocationBtn').addEventListener('click', () => {
                    this.updateLocation();
                });

                document.getElementById('endOperationBtn').addEventListener('click', () => {
                    this.endOperation();
                });

                document.getElementById('mapToggle').addEventListener('click', () => {
                    this.toggleMapType();
                });
            }

            setupUnloadHandlers() {
                // „Éñ„É©„Ç¶„Ç∂ÈñâÈéñÊôÇ„ÅÆËá™ÂãïÂâäÈô§
                window.addEventListener('beforeunload', () => {
                    if (this.myDocumentId) {
                        navigator.sendBeacon('/cleanup', JSON.stringify({id: this.myDocumentId}));
                        this.deleteMyData();
                    }
                });

                window.addEventListener('unload', () => {
                    if (this.myDocumentId) {
                        this.deleteMyData();
                    }
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.myDocumentId) {
                        this.deleteMyData();
                    }
                });
            }

            getCurrentPosition() {
                this.showLoading();
                
                if (!navigator.geolocation) {
                    this.showError('‰ΩçÁΩÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        this.hideLoading();
                        this.goToStep(2);
                    },
                    (error) => {
                        this.hideLoading();
                        let errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ';
                                break;
                        }
                        this.showError(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            }

            async handleRegistration() {
                const companyName = document.getElementById('companyName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();

                if (!companyName || !phoneNumber) {
                    this.showError('‰ºöÁ§æÂêç„Å®ÈõªË©±Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                if (!this.currentPosition) {
                    this.showError('‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    return;
                }

                this.showLoading();

                try {
                    // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂâäÈô§
                    await this.deleteExistingData(phoneNumber);

                    // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíÁôªÈå≤
                    const now = new Date();
                    const expiresAt = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                    
                    const customIcon = document.getElementById('imagePreview').style.display === 'block' 
                        ? document.getElementById('imagePreview').src : null;

                    const docRef = await collection.add({
                        company_name: companyName,
                        phone_number: phoneNumber,
                        latitude: this.currentPosition.lat,
                        longitude: this.currentPosition.lng,
                        custom_icon: customIcon,
                        created_at: now,
                        expires_at: expiresAt
                    });

                    this.myDocumentId = docRef.id;
                    this.expirationTime = expiresAt;

                    // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                    this.saveData({
                        companyName,
                        phoneNumber,
                        customIcon
                    });

                    this.hideLoading();
                    this.goToStep(3);
                    this.initMap();
                    this.startCountdown();

                } catch (error) {
                    this.hideLoading();
                    this.showError('ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            async deleteExistingData(phoneNumber) {
                const querySnapshot = await collection
                    .where('phone_number', '==', phoneNumber)
                    .get();

                const deletePromises = querySnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
            }

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 2 * 1024 * 1024) {
                    this.showError('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ2MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = 32;
                        canvas.height = 32;
                        
                        ctx.drawImage(img, 0, 0, 32, 32);
                        
                        const resizedDataUrl = canvas.toDataURL('image/png');
                        const preview = document.getElementById('imagePreview');
                        preview.src = resizedDataUrl;
                        preview.style.display = 'block';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            formatPhoneNumber(event) {
                let value = event.target.value.replace(/\D/g, '');
                if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
                }
                event.target.value = value;
            }

            initMap() {
                const mapOptions = {
                    center: this.currentPosition,
                    zoom: 12,
                    mapTypeId: this.isMapTypeRoad ? google.maps.MapTypeId.ROADMAP : google.maps.MapTypeId.SATELLITE
                };

                this.map = new google.maps.Map(document.getElementById('map'), mapOptions);
                this.subscribeToOperators();
                this.updateMapToggleButton();
            }

            subscribeToOperators() {
                const now = new Date();
                
                this.unsubscribe = collection
                    .where('expires_at', '>', now)
                    .onSnapshot((snapshot) => {
                        this.updateMarkers(snapshot.docs);
                        document.getElementById('operatorCount').textContent = snapshot.docs.length;
                    });
            }

            updateMarkers(docs) {
                // Êó¢Â≠ò„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];

                docs.forEach(doc => {
                    const data = doc.data();
                    const isMyMarker = doc.id === this.myDocumentId;
                    
                    let iconConfig;
                    if (isMyMarker && data.custom_icon) {
                        iconConfig = {
                            url: data.custom_icon,
                            scaledSize: new google.maps.Size(32, 32),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(16, 32)
                        };
                    } else if (isMyMarker) {
                        iconConfig = {
                            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                            scaledSize: new google.maps.Size(32, 32)
                        };
                    } else {
                        iconConfig = {
                            url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                            scaledSize: new google.maps.Size(32, 32)
                        };
                    }

                    const marker = new google.maps.Marker({
                        position: { lat: data.latitude, lng: data.longitude },
                        map: this.map,
                        title: data.company_name,
                        icon: iconConfig
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; min-width: 200px;">
                                <h3 style="margin: 0; font-size: 16px;">${data.company_name}</h3>
                                <p style="margin: 5px 0;">
                                    <a href="tel:${data.phone_number}" 
                                       style="color: #2563EB; text-decoration: none; font-size: 18px;">
                                        üìû ${data.phone_number}
                                    </a>
                                </p>
                                <small style="color: #666;">„Çø„ÉÉ„Éó„ÅßÈõªË©±„Çí„Åã„Åë„Åæ„Åô</small>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(this.map, marker);
                    });

                    this.markers.push(marker);
                });
            }

            toggleMapType() {
                if (this.map) {
                    this.isMapTypeRoad = !this.isMapTypeRoad;
                    const mapTypeId = this.isMapTypeRoad ? 
                        google.maps.MapTypeId.ROADMAP : 
                        google.maps.MapTypeId.SATELLITE;
                    
                    this.map.setMapTypeId(mapTypeId);
                    this.updateMapToggleButton();
                    
                    // Ë®≠ÂÆö„Çí‰øùÂ≠ò
                    localStorage.setItem('mapType', this.isMapTypeRoad ? 'roadmap' : 'satellite');
                }
            }

            updateMapToggleButton() {
                const button = document.getElementById('mapToggle');
                button.textContent = this.isMapTypeRoad ? 'üõ∞Ô∏è' : 'üó∫Ô∏è';
                button.title = this.isMapTypeRoad ? 'Ëà™Á©∫ÂÜôÁúü„Å´Âàá„ÇäÊõø„Åà' : 'Âú∞Âõ≥„Å´Âàá„ÇäÊõø„Åà';
            }

            async updateLocation() {
                if (!this.myDocumentId) return;

                this.getCurrentPosition();
                
                if (this.currentPosition) {
                    try {
                        await collection.doc(this.myDocumentId).update({
                            latitude: this.currentPosition.lat,
                            longitude: this.currentPosition.lng
                        });
                        this.showSuccess('‰ΩçÁΩÆÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    } catch (error) {
                        this.showError('‰ΩçÁΩÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            }

            async endOperation() {
                if (confirm('Á®ºÂÉç„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                    await this.deleteMyData();
                    this.showSuccess('Á®ºÂÉç„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }

            async deleteMyData() {
                if (this.myDocumentId) {
                    try {
                        await collection.doc(this.myDocumentId).delete();
                        this.myDocumentId = null;
                    } catch (error) {
                        console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
                    }
                }
            }

            startCountdown() {
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                }

                this.countdownTimer = setInterval(() => {
                    const now = new Date();
                    const remaining = this.expirationTime - now;

                    if (remaining <= 0) {
                        clearInterval(this.countdownTimer);
                        this.deleteMyData();
                        this.showSuccess('8ÊôÇÈñì„ÅåÁµåÈÅé„Åó„Åü„Åü„ÇÅËá™ÂãïÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                        return;
                    }

                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                    document.getElementById('timerDisplay').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            saveData(data) {
                localStorage.setItem('careTaxiData', JSON.stringify(data));
            }

            goToStep(step) {
                // „Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÈùûË°®Á§∫
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('mapContainer').classList.add('hidden');

                // ÊåáÂÆö„Åï„Çå„Åü„Çπ„ÉÜ„ÉÉ„Éó„ÇíË°®Á§∫
                if (step === 1) {
                    document.getElementById('step1').classList.remove('hidden');
                } else if (step === 2) {
                    document.getElementById('step2').classList.remove('hidden');
                } else if (step === 3) {
                    document.getElementById('mapContainer').classList.remove('hidden');
                }

                this.currentStep = step;
                this.updateStepIndicator();
            }

            updateStepIndicator() {
                const steps = document.querySelectorAll('.step');
                steps.forEach((step, index) => {
                    if (index + 1 <= this.currentStep) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
            }

            showLoading() {
                document.getElementById('loading').classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        document.addEventListener('DOMContentLoaded', () => {
            new CareTaxiApp();
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDjE6W3X%2Fhr7WE1Sl3Dyhbp4dzWI4qyy%2BBFvg70qEA2JYvN%2FBbGIXpGL3luDT27nwj7vW7D8bILLG4QGMPQaW7Yk2eS8rc9gGmogG%2FWaxC%2BAe2ErWGiUR%2F7KLPBEVOz721%2BSvpPDVjHss%2BcpucJWE2dRAMwnSjcgST%2BSAi3PJbXzgQxxq2rvW%2BdDBQ6OyYtIHub1X4Ds4KfqSgzm524jgRTeHeV8M9PCD%2ByYH4Xb60hU5FnQFte0XHoec3z%2FSb%2FXUaLve75ET8lCDtg%2F%2FFeO0eVfA6ltW7B%2FcYDyElcgLhmGteJW6psoPJ5WrfifqMZ1rFmjsNWOXWVnQrxq9hITKBxOWs%2BvVyc%2BmuQbWKN4hv82LxxRTh8Ny3yHW5wCEh5NCbXu3SOiluYOvDuVFyp4t7MVgbeonJdBapDl8yzZCndn5S2NsVIW6V0%2FY2uvMvkwGKexgyfcZ0ESpjuihvwnnNV53rpqawDarshTrsyHccIrkEL%2BNUHAtnf29LzCAm%2FcEIg%3D%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDjE6W3X/hr7WE1Sl3Dyhbp4dzWI4qyy+BFvg70qEA2JYvN/BbGIXpGL3luDT27nwj7vW7D8bILLG4QGMPQaW7Yk2eS8rc9gGmogG/WaxC+Ae2ErWGiUR/7KLPBEVOz721+SvpPDVjHss+cpucJWE2dRAMwnSjcgST+SAi3PJbXzgQxxq2rvW+dDBQ6OyYtIHub1X4Ds4KfqSgzm524jgRTeHeV8M9PCD+yYH4Xb60hU5FnQFte0XHoec3z/Sb/XUaLve75ET8lCDtg//FeO0eVfA6ltW7B/cYDyElcgLhmGteJW6psoPJ5WrfifqMZ1rFmjsNWOXWVnQrxq9hITKBxOWs+vVyc+muQbWKN4hv82LxxRTh8Ny3yHW5wCEh5NCbXu3SOiluYOvDuVFyp4t7MVgbeonJdBapDl8yzZCndn5S2NsVIW6V0/Y2uvMvkwGKexgyfcZ0ESpjuihvwnnNV53rpqawDarshTrsyHccIrkEL+NUHAtnf29LzCAm/cEIg==";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
