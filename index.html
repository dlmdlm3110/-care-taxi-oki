
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ä½ç½®å…±æœ‰ã‚¢ãƒ—ãƒªã€Œã„ã¾ã“ã“ã€</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #4fb3d9 0%, #c3e8f7 100%);
            min-height: 100vh;
        }
        
        .step-indicator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(79, 179, 217, 0.3);
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            margin: 0 auto 10px;
        }
        
        .step-number.active {
            background: #4fb3d9;
        }
        
        .step-number.completed {
            background: #10b981;
        }
        
        .step-number.inactive {
            background: #9ca3af;
        }
        
        .input-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin: 20px;
            box-shadow: 0 8px 32px rgba(79, 179, 217, 0.3);
        }
        
        .input-field {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #4fb3d9;
            box-shadow: 0 0 0 3px rgba(79, 179, 217, 0.1);
        }
        
        .btn-primary {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            background: #4fb3d9;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .btn-primary:hover {
            background: #3a9bc1;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 179, 217, 0.3);
        }
        
        .btn-secondary {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }
        
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: bold;
            color: #4fb3d9;
            text-align: center;
        }
        
        .map-type-toggle {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .map-type-toggle:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .image-upload-container {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        
        .image-upload-container:hover {
            border-color: #4fb3d9;
        }
        
        .image-preview {
            max-width: 64px;
            max-height: 64px;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        
        .file-input {
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .input-container {
                margin: 10px;
                padding: 20px;
            }
            
            .map-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .timer-display {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .map-type-toggle {
                top: 60px;
                right: 10px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ä½ç½®æƒ…å ±è¨±å¯ -->
    <div id="step1" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <div class="step-indicator text-center">
                <div class="flex justify-center mb-6">
                    <div class="step-number active">1</div>
                    <div class="step-number inactive mx-4">2</div>
                    <div class="step-number inactive">3</div>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-4">
                    ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ä½ç½®å…±æœ‰ã‚¢ãƒ—ãƒª<br>ã€Œã„ã¾ã“ã“ã€
                </h1>
                <div class="text-6xl mb-4">ğŸ“</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">ä½ç½®æƒ…å ±ã®è¨±å¯</h2>
                <p class="text-gray-600 mb-6">
                    ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ã€åœ°å›³ä¸Šã§ä½ç½®ã‚’å…±æœ‰ã—ã¾ã™ã€‚<br>
                    ã€Œè¨±å¯ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
                </p>
                <button id="getLocationBtn" class="btn-primary">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
                </button>
                <div id="locationError" class="error-message hidden">
                    ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: äº‹æ¥­è€…æƒ…å ±å…¥åŠ› -->
    <div id="step2" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="max-w-md w-full">
            <div class="step-indicator text-center">
                <div class="flex justify-center mb-6">
                    <div class="step-number completed">1</div>
                    <div class="step-number active mx-4">2</div>
                    <div class="step-number inactive">3</div>
                </div>
                <div class="text-6xl mb-4">ğŸ‘”</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">äº‹æ¥­è€…æƒ…å ±ã‚’å…¥åŠ›</h2>
                <p class="text-gray-600 mb-6">
                    ä¼šç¤¾åãƒ»é›»è©±ç•ªå·ãƒ»ãƒ­ã‚´ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                </p>
            </div>
            
            <div class="input-container">
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">
                        <i class="fas fa-building mr-2"></i>ä¼šç¤¾å
                    </label>
                    <input type="text" id="companyName" class="input-field" placeholder="â—‹â—‹ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">
                        <i class="fas fa-phone mr-2"></i>é›»è©±ç•ªå·
                    </label>
                    <input type="tel" id="phoneNumber" class="input-field" placeholder="090-1234-5678" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">
                        <i class="fas fa-image mr-2"></i>ãƒ­ã‚´ç”»åƒï¼ˆä»»æ„ï¼‰
                    </label>
                    <div class="image-upload-container" onclick="document.getElementById('logoFile').click()">
                        <div id="imagePreviewContainer" class="hidden">
                            <img id="imagePreview" class="image-preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                            <p class="text-sm text-gray-600 mt-2">ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´</p>
                        </div>
                        <div id="imageUploadPrompt">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                            <p class="text-sm text-gray-500">JPG, PNG, GIF (2MBä»¥ä¸‹)</p>
                        </div>
                    </div>
                    <input type="file" id="logoFile" class="file-input" accept="image/*">
                </div>
                
                <button id="registerBtn" class="btn-primary">
                    <i class="fas fa-map mr-2"></i>
                    åœ°å›³ã«ç™»éŒ²ã™ã‚‹
                </button>
                
                <div id="savedInfoContainer" class="hidden">
                    <button id="editInfoBtn" class="btn-secondary">
                        <i class="fas fa-edit mr-2"></i>
                        æƒ…å ±ã‚’å¤‰æ›´
                    </button>
                    <button id="clearSavedInfoBtn" class="btn-secondary">
                        <i class="fas fa-trash mr-2"></i>
                        ä¿å­˜ã—ãŸæƒ…å ±ã‚’å‰Šé™¤
                    </button>
                </div>
                
                <div id="registrationError" class="error-message hidden"></div>
                <div id="registrationSuccess" class="success-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: åœ°å›³è¡¨ç¤º -->
    <div id="step3" class="hidden">
        <div class="map-container">
            <div id="map"></div>
            
            <div class="timer-display">
                <div class="text-sm mb-1">æ®‹ã‚Šæ™‚é–“</div>
                <div id="countdown" class="text-xl font-bold">08:00:00</div>
                <div class="text-xs mt-1">8æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™</div>
            </div>
            
            <button id="mapTypeToggle" class="map-type-toggle" title="åœ°å›³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ">
                <i id="mapTypeIcon" class="fas fa-map"></i>
                <div class="text-xs mt-1" id="mapTypeText">èˆªç©ºå†™çœŸ</div>
            </button>
            
            <div class="map-controls">
                <div class="text-center mb-4">
                    <div class="text-lg font-bold text-gray-800">
                        <i class="fas fa-users mr-2"></i>
                        <span id="activeCount">1</span>å°ã®ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ãŒç¨¼åƒä¸­
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        <i class="fas fa-phone mr-1"></i>
                        ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›»è©±ç™ºä¿¡
                    </div>
                </div>
                
                <button id="updateLocationBtn" class="btn-secondary" style="flex: 1;">
                    <i class="fas fa-sync-alt mr-2"></i>
                    ä½ç½®æ›´æ–°
                </button>
                
                <button id="endServiceBtn" class="btn-danger" style="flex: 1;">
                    <i class="fas fa-stop mr-2"></i>
                    ç¨¼åƒçµ‚äº†
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8NRDN9NszAV2vnMbhej2Vh-bpqDxCuqU&libraries=geometry"></script>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCJIGNkMZJr4pPvG2YMAx2QaySnD-LZZs",
            authDomain: "care-taxi-okinawa.firebaseapp.com",
            projectId: "care-taxi-okinawa",
            storageBucket: "care-taxi-okinawa.firebasestorage.app",
            messagingSenderId: "1052247620667",
            appId: "1:1052247620667:web:6ccf1f12f5ec6bf36f0f0"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collection = db.collection('care_taxi_locations');

        class ImakokoApp {
            constructor() {
                this.currentStep = 1;
                this.currentPosition = null;
                this.map = null;
                this.markers = [];
                this.unsubscribe = null;
                this.countdownTimer = null;
                this.expirationTime = null;
                this.userDocId = null;
                this.customIcon = null;
                this.isMapTypeToggling = false;
                this.currentMapType = 'roadmap';
                
                this.init();
            }
            
            init() {
                console.log('ã„ã¾ã“ã“ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
                this.loadSavedInfo();
                this.loadSavedMapType();
                this.setupEventListeners();
                this.setupAutoDelete();
                
                // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                this.setupImageUpload();
            }
            
            loadSavedMapType() {
                const savedMapType = localStorage.getItem('imakoko_map_type');
                if (savedMapType && (savedMapType === 'roadmap' || savedMapType === 'satellite')) {
                    this.currentMapType = savedMapType;
                    console.log('ä¿å­˜ã•ã‚ŒãŸãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’èª­ã¿è¾¼ã¿:', this.currentMapType);
                }
            }
            
            saveMapType() {
                localStorage.setItem('imakoko_map_type', this.currentMapType);
                console.log('ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’ä¿å­˜:', this.currentMapType);
            }
            
            loadSavedInfo() {
                const savedInfo = localStorage.getItem('imakoko_user_info');
                const savedImage = localStorage.getItem('imakoko_custom_icon');
                
                if (savedInfo) {
                    const info = JSON.parse(savedInfo);
                    document.getElementById('companyName').value = info.companyName || '';
                    document.getElementById('phoneNumber').value = info.phoneNumber || '';
                }
                
                if (savedImage) {
                    this.customIcon = savedImage;
                    this.showImagePreview(savedImage);
                }
            }
            
            saveUserInfo() {
                const companyName = document.getElementById('companyName').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                
                const userInfo = {
                    companyName: companyName,
                    phoneNumber: phoneNumber
                };
                
                localStorage.setItem('imakoko_user_info', JSON.stringify(userInfo));
                
                if (this.customIcon) {
                    localStorage.setItem('imakoko_custom_icon', this.customIcon);
                }
            }
            
            setupImageUpload() {
                const fileInput = document.getElementById('logoFile');
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.processImageFile(file);
                    }
                });
            }
            
            processImageFile(file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = 32;
                        canvas.height = 32;
                        
                        ctx.drawImage(img, 0, 0, 32, 32);
                        
                        const resizedImageData = canvas.toDataURL('image/png');
                        this.customIcon = resizedImageData;
                        this.showImagePreview(resizedImageData);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            showImagePreview(imageSrc) {
                document.getElementById('imagePreview').src = imageSrc;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
                document.getElementById('imageUploadPrompt').classList.add('hidden');
            }
            
            setupEventListeners() {
                // ä½ç½®æƒ…å ±å–å¾—
                document.getElementById('getLocationBtn').addEventListener('click', () => {
                    this.getCurrentPosition();
                });
                
                // ç™»éŒ²ãƒœã‚¿ãƒ³
                document.getElementById('registerBtn').addEventListener('click', () => {
                    this.handleRegistration();
                });
                
                // ä½ç½®æ›´æ–°
                document.getElementById('updateLocationBtn').addEventListener('click', () => {
                    this.updateLocation();
                });
                
                // ç¨¼åƒçµ‚äº†
                document.getElementById('endServiceBtn').addEventListener('click', () => {
                    this.endService();
                });
                
                // æƒ…å ±å¤‰æ›´
                document.getElementById('editInfoBtn').addEventListener('click', () => {
                    this.toggleEditMode();
                });
                
                // ä¿å­˜æƒ…å ±å‰Šé™¤
                document.getElementById('clearSavedInfoBtn').addEventListener('click', () => {
                    this.clearSavedInfo();
                });
                
                // ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('mapTypeToggle').addEventListener('click', () => {
                    this.toggleMapType();
                });
                
                // é›»è©±ç•ªå·è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                document.getElementById('phoneNumber').addEventListener('input', this.formatPhoneNumber);
            }
            
            setupAutoDelete() {
                // ãƒ–ãƒ©ã‚¦ã‚¶é–‰é–æ™‚ã®è‡ªå‹•å‰Šé™¤
                window.addEventListener('beforeunload', () => {
                    this.deleteUserLocation();
                });
                
                window.addEventListener('unload', () => {
                    this.deleteUserLocation();
                });
                
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.deleteUserLocation();
                    }
                });
            }
            
            getCurrentPosition() {
                if (!navigator.geolocation) {
                    this.showError('ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                const btn = document.getElementById('getLocationBtn');
                btn.innerHTML = '<div class="loading-spinner"></div> ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
                btn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ:', this.currentPosition);
                        this.showStep(2);
                    },
                    (error) => {
                        console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        this.showError('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        btn.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹';
                        btn.disabled = false;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            }
            
            async handleRegistration() {
                const companyName = document.getElementById('companyName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                
                if (!companyName || !phoneNumber) {
                    this.showError('ä¼šç¤¾åã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                if (!this.currentPosition) {
                    this.showError('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }
                
                const btn = document.getElementById('registerBtn');
                btn.innerHTML = '<div class="loading-spinner"></div> ç™»éŒ²ä¸­...';
                btn.disabled = true;
                
                try {
                    // åŒã˜é›»è©±ç•ªå·ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    await this.deleteDuplicateData(phoneNumber);
                    
                    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
                    await this.registerOperator({
                        companyName,
                        phoneNumber,
                        latitude: this.currentPosition.lat,
                        longitude: this.currentPosition.lng,
                        customIcon: this.customIcon
                    });
                    
                    this.saveUserInfo();
                    this.showStep(3);
                } catch (error) {
                    console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                    this.showError('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    btn.innerHTML = '<i class="fas fa-map mr-2"></i>åœ°å›³ã«ç™»éŒ²ã™ã‚‹';
                    btn.disabled = false;
                }
            }
            
            async deleteDuplicateData(phoneNumber) {
                try {
                    const querySnapshot = await collection.where('phone_number', '==', phoneNumber).get();
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    if (!querySnapshot.empty) {
                        await batch.commit();
                        console.log(`${querySnapshot.size}ä»¶ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    }
                } catch (error) {
                    console.error('é‡è¤‡ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            async registerOperator(data) {
                const now = new Date();
                const expiresAt = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                
                const docData = {
                    company_name: data.companyName,
                    phone_number: data.phoneNumber,
                    latitude: data.latitude,
                    longitude: data.longitude,
                    created_at: now,
                    expires_at: expiresAt
                };
                
                if (data.customIcon) {
                    docData.custom_icon = data.customIcon;
                }
                
                const docRef = await collection.add(docData);
                this.userDocId = docRef.id;
                this.expirationTime = expiresAt;
                console.log('ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å®Œäº†:', docRef.id);
            }
            
            showStep(stepNumber) {
                // å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’éè¡¨ç¤º
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
                
                // æŒ‡å®šã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
                document.getElementById(`step${stepNumber}`).classList.remove('hidden');
                this.currentStep = stepNumber;
                
                if (stepNumber === 3) {
                    setTimeout(() => {
                        this.initMap();
                        this.startCountdown();
                    }, 100);
                }
            }
            
            initMap() {
                const mapOptions = {
                    center: this.currentPosition || { lat: 26.2124, lng: 127.6792 },
                    zoom: 11,
                    mapTypeId: this.currentMapType === 'satellite' ? google.maps.MapTypeId.SATELLITE : google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                };
                
                this.map = new google.maps.Map(document.getElementById('map'), mapOptions);
                console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†ã€ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—:', this.currentMapType);
                
                // ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—è¡¨ç¤ºã‚’æ›´æ–°
                this.updateMapTypeDisplay();
                
                // Firestoreãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–é–‹å§‹
                this.subscribeToOperators();
            }
            
            toggleMapType() {
                if (this.isMapTypeToggling || !this.map) return;
                
                this.isMapTypeToggling = true;
                console.log('ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆé–‹å§‹ã€ç¾åœ¨:', this.currentMapType);
                
                try {
                    if (this.currentMapType === 'roadmap') {
                        this.currentMapType = 'satellite';
                        this.map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                        console.log('èˆªç©ºå†™çœŸã«åˆ‡ã‚Šæ›¿ãˆ');
                    } else {
                        this.currentMapType = 'roadmap';
                        this.map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°å›³ã«åˆ‡ã‚Šæ›¿ãˆ');
                    }
                    
                    this.updateMapTypeDisplay();
                    this.saveMapType();
                } catch (error) {
                    console.error('ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    setTimeout(() => {
                        this.isMapTypeToggling = false;
                    }, 500);
                }
            }
            
            updateMapTypeDisplay() {
                const icon = document.getElementById('mapTypeIcon');
                const text = document.getElementById('mapTypeText');
                
                if (this.currentMapType === 'satellite') {
                    icon.className = 'fas fa-map';
                    text.textContent = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
                } else {
                    icon.className = 'fas fa-satellite';
                    text.textContent = 'èˆªç©ºå†™çœŸ';
                }
            }
            
            subscribeToOperators() {
                const now = new Date();
                
                this.unsubscribe = collection
                    .where('expires_at', '>', now)
                    .onSnapshot((snapshot) => {
                        console.log(`Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—: ${snapshot.docs.length}ä»¶`);
                        this.updateMarkers(snapshot.docs);
                        this.updateActiveCount(snapshot.docs.length);
                    }, (error) => {
                        console.error('Firestoreç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
                    });
            }
            
            updateMarkers(docs) {
                // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];
                
                docs.forEach(doc => {
                    const data = doc.data();
                    const isCurrentUser = doc.id === this.userDocId;
                    
                    let iconConfig;
                    
                    if (data.custom_icon && isCurrentUser) {
                        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ç”¨
                        iconConfig = {
                            url: data.custom_icon,
                            scaledSize: new google.maps.Size(32, 32),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(16, 32)
                        };
                    } else {
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ç”¨
                        const color = isCurrentUser ? 'red' : 'blue';
                        iconConfig = {
                            url: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
                            scaledSize: new google.maps.Size(32, 32)
                        };
                    }
                    
                    const marker = new google.maps.Marker({
                        position: { lat: data.latitude, lng: data.longitude },
                        map: this.map,
                        title: data.company_name,
                        icon: iconConfig
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; min-width: 200px; text-align: center;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">${data.company_name}</h3>
                                <p style="margin: 10px 0;">
                                    <a href="tel:${data.phone_number}" 
                                       style="color: #4fb3d9; text-decoration: none; font-size: 18px; font-weight: bold;">
                                        ğŸ“ ${data.phone_number}
                                    </a>
                                </p>
                                <small style="color: #666;">ã‚¿ãƒƒãƒ—ã§é›»è©±ã‚’ã‹ã‘ã¾ã™</small>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        // ä»–ã®InfoWindowã‚’é–‰ã˜ã‚‹
                        this.markers.forEach(m => {
                            if (m.infoWindow) {
                                m.infoWindow.close();
                            }
                        });
                        infoWindow.open(this.map, marker);
                    });
                    
                    marker.infoWindow = infoWindow;
                    this.markers.push(marker);
                    
                    console.log(`ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ: ${data.company_name} at (${data.latitude}, ${data.longitude})`);
                });
            }
            
            updateActiveCount(count) {
                document.getElementById('activeCount').textContent = count;
            }
            
            startCountdown() {
                if (!this.expirationTime) return;
                
                this.countdownTimer = setInterval(() => {
                    const now = new Date().getTime();
                    const expiration = this.expirationTime.getTime();
                    const timeLeft = expiration - now;
                    
                    if (timeLeft <= 0) {
                        clearInterval(this.countdownTimer);
                        document.getElementById('countdown').textContent = '00:00:00';
                        this.endService();
                        return;
                    }
                    
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    document.getElementById('countdown').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
            
            async updateLocation() {
                const btn = document.getElementById('updateLocationBtn');
                btn.innerHTML = '<div class="loading-spinner"></div> æ›´æ–°ä¸­...';
                btn.disabled = true;
                
                try {
                    await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                this.currentPosition = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                resolve();
                            },
                            reject,
                            { enableHighAccuracy: true, timeout: 10000 }
                        );
                    });
                    
                    if (this.userDocId) {
                        await collection.doc(this.userDocId).update({
                            latitude: this.currentPosition.lat,
                            longitude: this.currentPosition.lng,
                            updated_at: new Date()
                        });
                        
                        this.showSuccess('ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    this.showError('ä½ç½®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                } finally {
                    btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>ä½ç½®æ›´æ–°';
                    btn.disabled = false;
                }
            }
            
            async endService() {
                if (confirm('æœ¬å½“ã«ç¨¼åƒã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nä½ç½®æƒ…å ±ãŒåœ°å›³ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                    await this.deleteUserLocation();
                    alert('ç¨¼åƒã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚');
                    location.reload();
                }
            }
            
            async deleteUserLocation() {
                if (this.userDocId) {
                    try {
                        await collection.doc(this.userDocId).delete();
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    } catch (error) {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
            }
            
            toggleEditMode() {
                const editBtn = document.getElementById('editInfoBtn');
                const isEditing = editBtn.textContent.includes('å¤‰æ›´');
                
                if (isEditing) {
                    document.getElementById('companyName').readOnly = false;
                    document.getElementById('phoneNumber').readOnly = false;
                    document.getElementById('savedInfoContainer').classList.add('hidden');
                    editBtn.innerHTML = '<i class="fas fa-save mr-2"></i>å¤‰æ›´ã‚’ä¿å­˜';
                } else {
                    this.saveUserInfo();
                    document.getElementById('companyName').readOnly = true;
                    document.getElementById('phoneNumber').readOnly = true;
                    editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>æƒ…å ±ã‚’å¤‰æ›´';
                    this.showSuccess('æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                }
            }
            
            clearSavedInfo() {
                if (confirm('ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem('imakoko_user_info');
                    localStorage.removeItem('imakoko_custom_icon');
                    document.getElementById('companyName').value = '';
                    document.getElementById('phoneNumber').value = '';
                    this.customIcon = null;
                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                    document.getElementById('imageUploadPrompt').classList.remove('hidden');
                    this.showSuccess('ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            }
            
            formatPhoneNumber(event) {
                let value = event.target.value.replace(/\D/g, '');
                if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
                }
                event.target.value = value;
            }
            
            showError(message) {
                const errorDiv = document.getElementById('locationError') || document.getElementById('registrationError');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                    setTimeout(() => errorDiv.classList.add('hidden'), 5000);
                }
            }
            
            showSuccess(message) {
                const successDiv = document.getElementById('registrationSuccess');
                if (successDiv) {
                    successDiv.textContent = message;
                    successDiv.classList.remove('hidden');
                    setTimeout(() => successDiv.classList.add('hidden'), 3000);
                }
            }
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new ImakokoApp();
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDsIBQTV5FvPghED7isr1GUqd0HYoeWfuWAHlkvhBUUZziX0SQ6UJxfVXEZmCnovuUOqP%2BlILy39v0JVIGMGXZ%2B3XMFtUf6QT88gEioIS7D7AMS9S0v1qzZt6%2FBvmDtGSGe6JnXS7%2F6FL55M94D8IdH5uLG%2FUJ0zdiR9C0K50Bd6r3A3Wy5jcmz6Q1vYVHO%2B5lyZBXm%2FGmVowdoZJtCHIDNE%2BwP3UfFRvFPMrKt6JotYDw6XfqP9xgpupJT1GQi0yKMHfIdVWf3Ks2w%2FEzUxz6fCRqvdowNsp3PxXrmsbrkDgR%2F82K1crcqjdaCzWrKx0ADoLsS5G2StIY7YvobHOdfNXXqQ3RXlEwJgqK95%2BBQLSJFb7PUcNDkH%2BkfmYPlf7Z%2BQePQeSQZ1D4OhdkzYi0c8REUG8Y9KAPj0UgWjBrvmhTDXwBqEdHKCzSPeuERKw8NkzzXNRpzX2878ugZsLXIHVwT0BuVQ5xcDOpdwxlM4%2BxCBRhIv01YZSZFc0sNT%2FqA%3D%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDsIBQTV5FvPghED7isr1GUqd0HYoeWfuWAHlkvhBUUZziX0SQ6UJxfVXEZmCnovuUOqP+lILy39v0JVIGMGXZ+3XMFtUf6QT88gEioIS7D7AMS9S0v1qzZt6/BvmDtGSGe6JnXS7/6FL55M94D8IdH5uLG/UJ0zdiR9C0K50Bd6r3A3Wy5jcmz6Q1vYVHO+5lyZBXm/GmVowdoZJtCHIDNE+wP3UfFRvFPMrKt6JotYDw6XfqP9xgpupJT1GQi0yKMHfIdVWf3Ks2w/EzUxz6fCRqvdowNsp3PxXrmsbrkDgR/82K1crcqjdaCzWrKx0ADoLsS5G2StIY7YvobHOdfNXXqQ3RXlEwJgqK95+BQLSJFb7PUcNDkH+kfmYPlf7Z+QePQeSQZ1D4OhdkzYi0c8REUG8Y9KAPj0UgWjBrvmhTDXwBqEdHKCzSPeuERKw8NkzzXNRpzX2878ugZsLXIHVwT0BuVQ5xcDOpdwxlM4+xCBRhIv01YZSZFc0sNT/qA==";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
