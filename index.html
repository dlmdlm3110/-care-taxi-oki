
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ä½ç½®å…±æœ‰ã‚¢ãƒ—ãƒªã€Œã„ã¾ã“ã“ã€</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuS7i+itkOOCv+OCr+OCt+ODvOS9jee9ruWFseiCreaOqeOAjOOBhOOBvuOBk+OBk+OAjSIsCiAgInNob3J0X25hbWUiOiAi44GE44G+44GT44GTIiwKICAiZGVzY3JpcHRpb24iOiAi5rKW57iE55yM5YaF44Gu5LuL6K2Q44K/44Kv44K344O85LqL5qWt6ICF5ZCR44GR44Oq44Ki44Or44K/44Kk44Og5L2N572u5oOF5aCx5YWx5pyJ44Ki44OX44OqIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzMzOTlmZiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBREFBQUFBd0NBTUFBQUJ4Q3hFQUFBQUFCM1JTVFJOVEFEOEFBSGVvd1dTQUFBQUJHZEJUVUVBQUxHUEMveGhCUUFBQUNSaUQ4QUFCckxDQk00MFFCQmdMNElnLyIsInNpemVzIjoiNDh4NDgiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0KICA=" >
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
        }
        
        .step-indicator {
            background: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .step-indicator.active {
            background: #2196f3;
            color: white;
        }
        
        .step-indicator.completed {
            background: #4caf50;
            color: white;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            margin: 20px;
        }
        
        .input-field {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }
        
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976d2;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-secondary {
            background: #9e9e9e;
            color: white;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .map-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 1000;
            font-weight: bold;
            color: #2196f3;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #ffcdd2;
        }
        
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #c8e6c9;
        }
        
        .info-saved {
            background: #e3f2fd;
            color: #1976d2;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 14px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .card {
                margin: 10px;
                padding: 20px;
            }
            
            .map-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ä½ç½®æƒ…å ±è¨±å¯ -->
    <div id="step1" class="container mx-auto max-w-md">
        <div class="card text-center">
            <div class="step-indicator active">1</div>
            <h1 class="text-2xl font-bold mb-4 text-gray-800">ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ä½ç½®å…±æœ‰ã‚¢ãƒ—ãƒª</h1>
            <h2 class="text-xl font-bold mb-6 text-blue-600">ã€Œã„ã¾ã“ã“ã€</h2>
            <i class="fas fa-map-marker-alt text-6xl text-blue-500 mb-6"></i>
            <p class="text-lg mb-6 text-gray-700">ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
            <p class="text-sm mb-8 text-gray-600">ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ã€ä»–ã®äº‹æ¥­è€…ã¨ä½ç½®ã‚’å…±æœ‰ã—ã¾ã™</p>
            <button id="allowLocationBtn" class="btn btn-primary">
                <i class="fas fa-location-arrow mr-2"></i>ä½ç½®æƒ…å ±ã‚’è¨±å¯ã™ã‚‹
            </button>
            <div id="locationError" class="error-message hidden">
                ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: äº‹æ¥­è€…æƒ…å ±å…¥åŠ› -->
    <div id="step2" class="container mx-auto max-w-md hidden">
        <div class="card">
            <div class="text-center mb-6">
                <div class="step-indicator completed">1</div>
                <div class="step-indicator active">2</div>
            </div>
            <i class="fas fa-user-tie text-6xl text-blue-500 mb-6 text-center block"></i>
            <h2 class="text-xl font-bold mb-4 text-center">äº‹æ¥­è€…æƒ…å ±ã‚’å…¥åŠ›</h2>
            <p class="text-center mb-6 text-gray-600">ä¼šç¤¾åã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            
            <div id="savedInfoNotice" class="info-saved hidden">
                <i class="fas fa-info-circle mr-2"></i>
                å‰å›ã®æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™
            </div>
            
            <form id="operatorForm">
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700">
                        <i class="fas fa-building mr-2"></i>ä¼šç¤¾å
                    </label>
                    <input type="text" id="companyName" class="input-field" placeholder="â—‹â—‹ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2 text-gray-700">
                        <i class="fas fa-phone mr-2"></i>é›»è©±ç•ªå·
                    </label>
                    <input type="tel" id="phoneNumber" class="input-field" placeholder="090-1234-5678" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-map mr-2"></i>åœ°å›³ã«ç™»éŒ²ã™ã‚‹
                </button>
                
                <button type="button" id="editInfoBtn" class="btn btn-secondary hidden">
                    <i class="fas fa-edit mr-2"></i>æƒ…å ±ã‚’å¤‰æ›´
                </button>
                
                <button type="button" id="clearInfoBtn" class="btn btn-warning hidden">
                    <i class="fas fa-trash mr-2"></i>ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã‚’å‰Šé™¤
                </button>
            </form>
            
            <div id="registrationError" class="error-message hidden"></div>
            <div id="loadingMessage" class="text-center text-blue-600 hidden">
                <i class="fas fa-spinner fa-spin mr-2"></i>ç™»éŒ²ä¸­...
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: åœ°å›³è¡¨ç¤º -->
    <div id="step3" class="hidden">
        <div id="map"></div>
        
        <div class="timer-display">
            <i class="fas fa-clock mr-2"></i>
            æ®‹ã‚Šæ™‚é–“: <span id="timeRemaining">08:00:00</span>
            <div class="text-xs text-gray-600 mt-1">8æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™</div>
        </div>
        
        <div class="map-controls">
            <div class="text-center mb-4">
                <i class="fas fa-taxi text-blue-500 mr-2"></i>
                <span id="activeCount">1å°ã®ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ãŒç¨¼åƒä¸­</span>
            </div>
            <div class="text-sm text-gray-600 text-center mb-4">
                <i class="fas fa-info-circle mr-1"></i>
                ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›»è©±ç™ºä¿¡
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button id="updateLocationBtn" class="btn btn-warning">
                    <i class="fas fa-sync-alt mr-2"></i>ä½ç½®æ›´æ–°
                </button>
                <button id="endServiceBtn" class="btn btn-danger">
                    <i class="fas fa-stop mr-2"></i>ç¨¼åƒçµ‚äº†
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCJIGNkMZJr4pPvG2YMAx2QaySnD-LZZs",
            authDomain: "care-taxi-okinawa.firebaseapp.com",
            projectId: "care-taxi-okinawa",
            storageBucket: "care-taxi-okinawa.firebasestorage.app",
            messagingSenderId: "1052247620667",
            appId: "1:1052247620667:web:6ccf1f12f5ec6bf36f0f0"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = 'care_taxi_locations';

        class ImakokoApp {
            constructor() {
                this.currentStep = 1;
                this.userLocation = null;
                this.userDocId = null;
                this.map = null;
                this.markers = [];
                this.unsubscribe = null;
                this.countdownTimer = null;
                this.expirationTime = null;
                this.savedInfo = this.loadSavedInfo();
                
                this.init();
            }

            init() {
                console.log('ã„ã¾ã“ã“ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
                this.setupEventListeners();
                this.checkSavedInfo();
                this.setupAutoDelete();
            }

            loadSavedInfo() {
                try {
                    const saved = localStorage.getItem('imakoko_user_info');
                    return saved ? JSON.parse(saved) : null;
                } catch (error) {
                    console.error('ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }

            saveUserInfo(companyName, phoneNumber) {
                try {
                    const info = { companyName, phoneNumber, savedAt: new Date().toISOString() };
                    localStorage.setItem('imakoko_user_info', JSON.stringify(info));
                    this.savedInfo = info;
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            clearSavedInfo() {
                try {
                    localStorage.removeItem('imakoko_user_info');
                    this.savedInfo = null;
                    console.log('ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            checkSavedInfo() {
                if (this.savedInfo) {
                    document.getElementById('savedInfoNotice').classList.remove('hidden');
                    document.getElementById('companyName').value = this.savedInfo.companyName;
                    document.getElementById('phoneNumber').value = this.savedInfo.phoneNumber;
                    document.getElementById('editInfoBtn').classList.remove('hidden');
                    document.getElementById('clearInfoBtn').classList.remove('hidden');
                }
            }

            setupEventListeners() {
                // ä½ç½®æƒ…å ±è¨±å¯ãƒœã‚¿ãƒ³
                document.getElementById('allowLocationBtn').addEventListener('click', () => {
                    this.getCurrentPosition();
                });

                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
                document.getElementById('operatorForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegistration();
                });

                // æƒ…å ±å¤‰æ›´ãƒœã‚¿ãƒ³
                document.getElementById('editInfoBtn').addEventListener('click', () => {
                    document.getElementById('companyName').readOnly = false;
                    document.getElementById('phoneNumber').readOnly = false;
                    document.getElementById('companyName').focus();
                });

                // ä¿å­˜æƒ…å ±å‰Šé™¤ãƒœã‚¿ãƒ³
                document.getElementById('clearInfoBtn').addEventListener('click', () => {
                    if (confirm('ä¿å­˜ã•ã‚ŒãŸä¼šç¤¾åã¨é›»è©±ç•ªå·ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        this.clearSavedInfo();
                        document.getElementById('companyName').value = '';
                        document.getElementById('phoneNumber').value = '';
                        document.getElementById('savedInfoNotice').classList.add('hidden');
                        document.getElementById('editInfoBtn').classList.add('hidden');
                        document.getElementById('clearInfoBtn').classList.add('hidden');
                    }
                });

                // é›»è©±ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                document.getElementById('phoneNumber').addEventListener('input', this.formatPhoneNumber);

                // ä½ç½®æ›´æ–°ãƒœã‚¿ãƒ³
                document.getElementById('updateLocationBtn').addEventListener('click', () => {
                    this.updateLocation();
                });

                // ç¨¼åƒçµ‚äº†ãƒœã‚¿ãƒ³
                document.getElementById('endServiceBtn').addEventListener('click', () => {
                    this.endService();
                });

                // è‡ªå‹•å‰Šé™¤è¨­å®š
                this.setupAutoDelete();
            }

            getCurrentPosition() {
                const errorDiv = document.getElementById('locationError');
                errorDiv.classList.add('hidden');

                if (!navigator.geolocation) {
                    this.showError('locationError', 'ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ:', this.userLocation);
                        this.showStep(2);
                    },
                    (error) => {
                        console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        this.showError('locationError', 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            }

            formatPhoneNumber(event) {
                let value = event.target.value.replace(/\D/g, '');
                if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
                }
                event.target.value = value;
            }

            async handleRegistration() {
                const companyName = document.getElementById('companyName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();

                if (!companyName || !phoneNumber) {
                    this.showError('registrationError', 'ä¼šç¤¾åã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (!this.userLocation) {
                    this.showError('registrationError', 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }

                this.showLoading(true);

                try {
                    // é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    await this.removeDuplicateEntries(phoneNumber);

                    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
                    await this.registerOperator({
                        companyName,
                        phoneNumber,
                        latitude: this.userLocation.lat,
                        longitude: this.userLocation.lng
                    });

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
                    this.saveUserInfo(companyName, phoneNumber);

                    this.showStep(3);
                } catch (error) {
                    console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                    this.showError('registrationError', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async removeDuplicateEntries(phoneNumber) {
                try {
                    console.log('é‡è¤‡ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ä¸­:', phoneNumber);
                    const q = query(collection(db, COLLECTION_NAME), where('phone_number', '==', phoneNumber));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        console.log(`${querySnapshot.size}ä»¶ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’ç™ºè¦‹`);
                        const deletePromises = [];
                        querySnapshot.forEach((doc) => {
                            deletePromises.push(deleteDoc(doc.ref));
                        });
                        await Promise.all(deletePromises);
                        console.log('é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤å®Œäº†');
                    }
                } catch (error) {
                    console.error('é‡è¤‡ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    throw new Error('é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            async registerOperator(data) {
                const now = new Date();
                const expiresAt = new Date(now.getTime() + 8 * 60 * 60 * 1000);

                const docData = {
                    company_name: data.companyName,
                    phone_number: data.phoneNumber,
                    latitude: data.latitude,
                    longitude: data.longitude,
                    created_at: now,
                    expires_at: expiresAt
                };

                const docRef = await addDoc(collection(db, COLLECTION_NAME), docData);
                this.userDocId = docRef.id;
                this.expirationTime = expiresAt;
                console.log('ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å®Œäº†:', docRef.id);
            }

            showStep(step) {
                document.getElementById(`step${this.currentStep}`).classList.add('hidden');
                document.getElementById(`step${step}`).classList.remove('hidden');
                this.currentStep = step;

                if (step === 3) {
                    this.initMap();
                    this.subscribeToOperators();
                    this.startCountdown();
                }
            }

            initMap() {
                const defaultCenter = this.userLocation || { lat: 26.2124, lng: 127.6792 };
                
                this.map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultCenter,
                    zoom: 12,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });

                console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†');
            }

            subscribeToOperators() {
                const now = new Date();
                const q = query(collection(db, COLLECTION_NAME), where('expires_at', '>', now));

                this.unsubscribe = onSnapshot(q, (snapshot) => {
                    console.log(`Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—: ${snapshot.size}ä»¶`);
                    this.updateMarkers(snapshot.docs);
                }, (error) => {
                    console.error('Firestoreç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
                });
            }

            updateMarkers(docs) {
                // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];

                let count = 0;
                docs.forEach(doc => {
                    const data = doc.data();
                    const isCurrentUser = doc.id === this.userDocId;

                    const position = { 
                        lat: Number(data.latitude), 
                        lng: Number(data.longitude) 
                    };

                    const marker = new google.maps.Marker({
                        position: position,
                        map: this.map,
                        title: data.company_name,
                        icon: {
                            url: isCurrentUser ? 
                                'https://maps.google.com/mapfiles/ms/icons/red-dot.png' :
                                'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; min-width: 200px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333;">${data.company_name}</h3>
                                <p style="margin: 5px 0;">
                                    <a href="tel:${data.phone_number}" 
                                       style="color: #2196f3; text-decoration: none; font-size: 18px;">
                                        ğŸ“ ${data.phone_number}
                                    </a>
                                </p>
                                <small style="color: #666;">ã‚¿ãƒƒãƒ—ã§é›»è©±ã‚’ã‹ã‘ã¾ã™</small>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(this.map, marker);
                    });

                    this.markers.push(marker);
                    count++;

                    console.log(`ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ: ${data.company_name} at ${position.lat}, ${position.lng}`);
                });

                document.getElementById('activeCount').textContent = `${count}å°ã®ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼ãŒç¨¼åƒä¸­`;
            }

            startCountdown() {
                if (!this.expirationTime) return;

                this.countdownTimer = setInterval(() => {
                    const now = new Date();
                    const diff = this.expirationTime - now;

                    if (diff <= 0) {
                        document.getElementById('timeRemaining').textContent = '00:00:00';
                        clearInterval(this.countdownTimer);
                        return;
                    }

                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    document.getElementById('timeRemaining').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            async updateLocation() {
                if (!this.userDocId) return;

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        try {
                            const companyName = document.getElementById('companyName').value;
                            const phoneNumber = document.getElementById('phoneNumber').value;

                            // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                            if (this.userDocId) {
                                await deleteDoc(doc(db, COLLECTION_NAME, this.userDocId));
                            }

                            // æ–°ã—ã„ä½ç½®ã§å†ç™»éŒ²
                            await this.registerOperator({
                                companyName,
                                phoneNumber,
                                latitude: newLocation.lat,
                                longitude: newLocation.lng
                            });

                            this.userLocation = newLocation;
                            console.log('ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                        } catch (error) {
                            console.error('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    },
                    (error) => {
                        console.error('ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    }
                );
            }

            async endService() {
                if (confirm('ç¨¼åƒã‚’çµ‚äº†ã—ã¦ä½ç½®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    try {
                        await this.deleteUserData();
                        alert('ç¨¼åƒã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚');
                        location.reload();
                    } catch (error) {
                        console.error('ç¨¼åƒçµ‚äº†ã‚¨ãƒ©ãƒ¼:', error);
                        alert('ç¨¼åƒçµ‚äº†ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    }
                }
            }

            async deleteUserData() {
                if (this.userDocId) {
                    await deleteDoc(doc(db, COLLECTION_NAME, this.userDocId));
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            }

            setupAutoDelete() {
                // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è‡ªå‹•å‰Šé™¤
                window.addEventListener('beforeunload', () => {
                    if (this.userDocId) {
                        navigator.sendBeacon('/api/delete', JSON.stringify({ docId: this.userDocId }));
                    }
                });

                window.addEventListener('unload', () => {
                    this.deleteUserData();
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.userDocId) {
                        this.deleteUserData();
                    }
                });
            }

            showError(elementId, message) {
                const errorDiv = document.getElementById(elementId);
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }

            showLoading(show) {
                const loading = document.getElementById('loadingMessage');
                if (show) {
                    loading.classList.remove('hidden');
                } else {
                    loading.classList.add('hidden');
                }
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        window.addEventListener('DOMContentLoaded', () => {
            window.imakokoApp = new ImakokoApp();
        });
    </script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8NRDN9NszAV2vnMbhej2Vh-bpqDxCuqU&libraries=geometry" async defer></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDlhihd38yzad7hTBSsWqtt5dQqoiCMLaSJB7d6w%2FT8WmtRfdureJ7L%2B9JU6VzR4voWtYR9qi6xpCSj31TOpOvrtrULAG3Np3G8Ai2oTGUHVS0tc0PyC9i%2BOLnFZFxUiQfzsozCYR%2BiVWZSiTHyvKm14CRXYSleykQSP%2BGzP5NH06VpKpCSycEhIVLhOlrYh06lnIaV1r028IYUItExH%2BwdrILBySsaCE1D4%2BaRN4L71UcR5PryD5Iz%2BfuwZ87OdiuwNspzmNadZpOcsWSKEiAyR6pPkt3BGNMdKoqxPNzk1tHKMweD2tfMiJBNmSldv%2FAfxBkFfw8%2BYGluTABHLzWxrwB5rYJS8dZ%2F8lWQngvnmJRObOXhw33PUTl6HeP6IwwRV48ZZkxVYONB94tIyXFTzo6zO%2BCiudpjiCMbcJm0wxQ5wWIfhjli6dAZouk61XzepIL4okkQgWxR4XOWgU9dV7YfhNcU5JXW0J7Oo0M8t8vKAUMZfh97LiKooCSEJsbSSoPFV%2FjHXCDK3CopNknVY%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDlhihd38yzad7hTBSsWqtt5dQqoiCMLaSJB7d6w/T8WmtRfdureJ7L+9JU6VzR4voWtYR9qi6xpCSj31TOpOvrtrULAG3Np3G8Ai2oTGUHVS0tc0PyC9i+OLnFZFxUiQfzsozCYR+iVWZSiTHyvKm14CRXYSleykQSP+GzP5NH06VpKpCSycEhIVLhOlrYh06lnIaV1r028IYUItExH+wdrILBySsaCE1D4+aRN4L71UcR5PryD5Iz+fuwZ87OdiuwNspzmNadZpOcsWSKEiAyR6pPkt3BGNMdKoqxPNzk1tHKMweD2tfMiJBNmSldv/AfxBkFfw8+YGluTABHLzWxrwB5rYJS8dZ/8lWQngvnmJRObOXhw33PUTl6HeP6IwwRV48ZZkxVYONB94tIyXFTzo6zO+CiudpjiCMbcJm0wxQ5wWIfhjli6dAZouk61XzepIL4okkQgWxR4XOWgU9dV7YfhNcU5JXW0J7Oo0M8t8vKAUMZfh97LiKooCSEJsbSSoPFV/jHXCDK3CopNknVY=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
